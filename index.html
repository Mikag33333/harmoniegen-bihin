<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¢ãƒ«ãƒ¢ãƒ‹ãƒ¼ç„ æ©Ÿæãƒ»å‚™å“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        /* CSSã¯å¤‰æ›´ãªã— */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .database-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .database-status.connected {
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid #28a745;
            color: #155724;
        }

        .database-status.disconnected {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid #dc3545;
            color: #721c24;
        }

        .database-status.connecting {
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid #ffc107;
            color: #856404;
        }

        .gas-url-section {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .gas-url-section h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .main-content {
            padding: 20px;
        }
        
        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #20c997);
            color: white;
        }
        
        .btn:hover, .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .category-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin: 10px 0;
        }
        
        .category-btn {
            padding: 12px 8px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
            touch-action: manipulation;
            font-size: 14px;
        }
        
        .category-btn:hover, .category-btn:active {
            background: #f8f9fa;
        }
        
        .category-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }
        
        .item-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            position: relative;
        }
        
        .item-card.completed {
            border-color: #28a745;
            background: #f8fff9;
        }

        .item-card.syncing {
            border-color: #ffc107;
            background: #fff8e1;
        }

        .item-card.syncing::after {
            content: "ğŸ”„ åŒæœŸä¸­...";
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffc107;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .item-card:hover, .item-card:active {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .item-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            flex-direction: column;
        }
        
        @media (min-width: 500px) {
            .item-header {
                flex-direction: row;
                align-items: center;
            }
        }
        
        .item-photo {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #ddd;
            margin-bottom: 10px;
        }
        
        @media (min-width: 500px) {
            .item-photo {
                width: 100px;
                height: 100px;
                margin-right: 15px;
                margin-bottom: 0;
            }
        }
        
        .item-details {
            flex: 1;
        }
        
        .item-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .summary-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .summary-card {
            background: rgba(255,255,255,0.1);
            padding: 15px 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-card h4 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        
        .summary-card p {
            font-size: 0.9em;
        }
        
        .user-info {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .hidden {
            display: none !important;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
            flex-direction: column;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toggle-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .section {
                padding: 15px;
            }
            
            .category-buttons {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 6px;
            }
            
            .category-btn {
                padding: 10px 6px;
                font-size: 13px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ½ï¸ ã‚¢ãƒ«ãƒ¢ãƒ‹ãƒ¼ç„</h1>
            <p>æ©Ÿæãƒ»å‚™å“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆGoogle Sheetsç‰ˆï¼‰</p>
        </div>
        
        <div class="main-content">
            <!-- Google Apps Script URLè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="gas-url-section">
                <h4>âš™ï¸ Google Apps Script URLè¨­å®š</h4>
                <div class="form-group">
                    <label>Google Apps Script ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURL</label>
                    <input type="url" id="gasUrl" placeholder="https://script.google.com/macros/s/.../exec" 
                           value="https://script.google.com/macros/s/AKfycbyS16NIjTSXfXQnl6AgU-TfqjUuyCJQvj3ubeTTro_VJWG_kMb_rfMxhqljqH0hg0fA/exec">
                    <small style="color: #666; font-size: 12px;">
                        Google Apps Scriptã§ä½œæˆã—ãŸã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                    </small>
                </div>
                <button class="btn btn-primary" id="testConnectionBtn">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
            </div>

            <div id="databaseStatus" class="database-status connecting">
                ğŸŸ¡ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
            </div>
            
            <div class="section">
                <h3>ğŸ‘¤ å…¥åŠ›è€…è¨­å®š</h3>
                <div class="form-group">
                    <label>å…¥åŠ›è€…åã‚’é¸æŠã—ã¦ãã ã•ã„</label>
                    <select id="userSelect">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="ä¸‰ãƒ¶å°»">ä¸‰ãƒ¶å°»</option>
                        <option value="æ¡‚">æ¡‚</option>
                        <option value="é˜¿æ¯”ç•™">é˜¿æ¯”ç•™</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="setUserBtn">è¨­å®š</button>
                <div id="currentUser" class="user-info hidden"></div>
            </div>
            
            <div class="section">
                <h3>ğŸ“ æ–°ã—ã„å“ç›®ã‚’è¿½åŠ </h3>
                
                <div class="form-group">
                    <label>ğŸ“· å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ <span style="color: #6c757d; font-size: 14px;">(ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</span></label>
                    <input type="file" id="photoInput" accept="image/*" capture="environment">
                    <div id="photoPreview" class="hidden" style="margin-top: 10px;">
                        <img id="previewImage" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid #ddd;">
                        <p id="compressionInfo" style="font-size: 12px; color: #6c757d; margin-top: 5px;"></p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ğŸ“‹ å“å</label>
                    <input type="text" id="itemName" placeholder="å“ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                </div>
                
                <div class="form-group">
                    <label>ğŸ”¢ å€‹æ•°</label>
                    <input type="number" id="itemCount" value="1" min="1">
                </div>

                <div class="form-group">
                    <label>ğŸ“ ãƒ¡ãƒ¢ãƒ»å‚™è€ƒ</label>
                    <input type="text" id="itemMemo" placeholder="ã‚µã‚¤ã‚ºã€çŠ¶æ…‹ã€ç‰¹è¨˜äº‹é …ãªã©ï¼ˆä»»æ„ï¼‰">
                </div>
                
                <div class="form-group">
                    <label>ğŸ·ï¸ å±æ€§ã‚’é¸æŠ <span style="color: #6c757d; font-size: 14px;">(å¾Œã§å¤‰æ›´å¯èƒ½)</span></label>
                    <div class="category-buttons" id="categoryButtons">
                        <button class="category-btn" data-value="å¨æˆ¿å™¨å…·">å¨æˆ¿å™¨å…·</button>
                        <button class="category-btn" data-value="åº—å†…æ©Ÿæ">åº—å†…æ©Ÿæ</button>
                        <button class="category-btn" data-value="é£Ÿå™¨é¡">é£Ÿå™¨é¡</button>
                        <button class="category-btn" data-value="å‚™å“">å‚™å“</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>âš¡ å–æ‰±ã„æ–¹æ³• <span style="color: #6c757d; font-size: 14px;">(ç¤¾é•·ãŒå¾Œã§æ±ºå®š)</span></label>
                    <div class="category-buttons" id="handlingButtons">
                        <button class="category-btn" data-value="å‡¦åˆ†">å‡¦åˆ†</button>
                        <button class="category-btn" data-value="è­²æ¸¡">è­²æ¸¡</button>
                        <button class="category-btn" data-value="é€ã‚Š">é€ã‚Š</button>
                        <button class="category-btn" data-value="ä¿ç•™">ä¿ç•™</button>
                    </div>
                    <p class="toggle-hint">ğŸ’¡ åŒã˜ãƒœã‚¿ãƒ³ã‚’ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨é¸æŠè§£é™¤ã•ã‚Œã¾ã™</p>
                    <div id="destinationDiv" class="form-group hidden">
                        <label>è­²æ¸¡å…ˆ/é€ã‚Šå…ˆ</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px;" id="destinationButtons">
                            <button type="button" class="category-btn" data-value="å¯¾é¦¬">å¯¾é¦¬</button>
                            <button type="button" class="category-btn" data-value="è¥¿æ–°">è¥¿æ–°</button>
                            <button type="button" class="category-btn" data-value="ç¤¾é•·è‡ªå®…">ç¤¾é•·è‡ªå®…</button>
                            <button type="button" class="category-btn" data-value="ãã®ä»–">ãã®ä»–</button>
                        </div>
                        <input type="text" id="destination" placeholder="ãã®ä»–ã®å ´åˆã¯ç›´æ¥å…¥åŠ›" style="display: none;">
                        <p class="toggle-hint">ğŸ’¡ åŒã˜ãƒœã‚¿ãƒ³ã‚’ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨é¸æŠè§£é™¤ã•ã‚Œã¾ã™</p>
                    </div>
                </div>
                
                <button class="btn btn-success" id="addItemBtn">å“ç›®ã‚’è¿½åŠ </button>
                <p id="addItemStatus" style="font-size: 14px; color: #666; margin-top: 5px;">
                    âœ… æ¥ç¶šæ¸ˆã¿
                </p>
            </div>
            
            <div class="section">
                <h3>ğŸ“¦ ç™»éŒ²æ¸ˆã¿å“ç›®ä¸€è¦§</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="btn btn-info" id="refreshBtn">ğŸ”„ æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</button>
                    <button class="btn btn-primary" id="openSheetsBtn">ğŸ“Š Google Sheetsã§ç¢ºèª</button>
                </div>
                <div id="itemsList">
                    <p style="text-align: center; color: #6c757d; padding: 40px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>
            
            <div class="summary-section">
                <h3>ğŸ“Š é›†è¨ˆæƒ…å ±</h3>
                <div class="summary-grid" id="summaryGrid">
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>ç·å“ç›®æ•°</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>æ±ºå®šæ¸ˆã¿</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>å¨æˆ¿å™¨å…·</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>åº—å†…æ©Ÿæ</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>é£Ÿå™¨é¡</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>å‚™å“</p>
                    </div>
                </div>
                <button class="btn btn-success" id="exportBtn">ğŸ“„ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            </div>
        </div>
    </div>
    
    <script>
        (function() {
            'use strict';
            
            let currentUser = '';
            let items = [];
            let selectedCategory = '';
            let selectedHandling = '';
            let gasUrl = '';
            
            // æ¥ç¶šçŠ¶æ…‹ã®æ›´æ–°
            function updateConnectionStatus(status) {
                const statusDiv = document.getElementById('databaseStatus');
                statusDiv.className = 'database-status ' + status;
                
                switch(status) {
                    case 'connected':
                        statusDiv.innerHTML = 'ğŸŸ¢ Google Sheetsæ¥ç¶šæ¸ˆã¿ - ãƒ‡ãƒ¼ã‚¿åŒæœŸå¯èƒ½';
                        break;
                    case 'connecting':
                        statusDiv.innerHTML = 'ğŸŸ¡ ãƒ‡ãƒ¼ã‚¿åŒæœŸä¸­...';
                        break;
                    case 'disconnected':
                        statusDiv.innerHTML = 'ğŸ”´ æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                        break;
                }
            }
            
            // Google Apps Scriptã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            async function loadItemsFromAPI() {
                updateConnectionStatus('connecting');
                try {
                    if (!gasUrl) {
                        throw new Error('Google Apps Script URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    }

                    const response = await fetch(gasUrl + '?action=getItems', {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Google Apps Scriptã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Google Apps Scriptã‹ã‚‰ã®é…åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
                    if (Array.isArray(data)) {
                        items = data.map((item, index) => ({
                            id: item.id || item['ID'] || `item_${index}`,
                            name: item.name || item['å“å'] || '',
                            count: parseInt(item.count || item['å€‹æ•°']) || 1,
                            category: item.category || item['å±æ€§'] || 'å‚™å“',
                            handling: item.handling || item['å–æ‰±ã„æ–¹æ³•'] || 'æœªæ±ºå®š',
                            destination: item.destination || item['é€ã‚Šå…ˆ'] || '',
                            completed: item.completed === true || item.completed === 'true' || item['æ±ºå®šæ¸ˆã¿'] === true || item['æ±ºå®šæ¸ˆã¿'] === 'true',
                            addedBy: item.addedBy || item['ç™»éŒ²è€…'] || '',
                            addedAt: item.addedAt || item['ç™»éŒ²æ—¥æ™‚'] || '',
                            memo: item.memo || item['ãƒ¡ãƒ¢'] || '',
                            photoUrl: item.photoUrl || item['å†™çœŸURL'] || null
                        }));
                    } else {
                        items = [];
                    }

                    displayItems();
                    updateSummary();
                    updateConnectionStatus('connected');
                    console.log('Google Apps Scriptã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', items.length, 'ä»¶');
                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    updateConnectionStatus('disconnected');
                    alert('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            }
            
            // Google Apps Scriptã«å“ç›®è¿½åŠ ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
            async function addItemToAPI(item) {
                const loadingOverlay = showLoading('å“ç›®ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™...');
                try {
                    if (!gasUrl) {
                        throw new Error('Google Apps Script URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    }

                    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åŠ¹ç‡çš„ã«ä½œæˆ
                    const formData = new FormData();
                    const formFields = {
                        action: 'addItem',
                        name: item.name,
                        count: item.count.toString(),
                        category: item.category,
                        handling: item.handling,
                        destination: item.destination || '',
                        addedBy: item.addedBy,
                        memo: item.memo || '',
                        photoDataUrl: item.photoDataUrl || ''
                    };

                    // ä¸€æ‹¬ã§ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
                    Object.entries(formFields).forEach(([key, value]) => {
                        formData.append(key, value);
                    });

                    console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º:', item.photoDataUrl ? `${Math.round(item.photoDataUrl.length/1024)}KB` : '0KB');

                    const startTime = Date.now();
                    const response = await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'cors',
                        body: formData
                    });
                    const endTime = Date.now();
                    
                    console.log(`APIå‘¼ã³å‡ºã—æ™‚é–“: ${endTime - startTime}ms`);

                    if (!response.ok) {
                        throw new Error(`è¿½åŠ ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    if (result.success) {
                        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’æ›´æ–°
                        loadingOverlay.innerHTML = '<div class="loading-spinner"></div><div>ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ä¸­...</div>';
                        
                        await loadItemsFromAPI();
                        hideLoading();
                        
                        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                        const successMsg = document.createElement('div');
                        successMsg.style.cssText = `
                            position: fixed; top: 20px; right: 20px; z-index: 10000;
                            background: #28a745; color: white; padding: 15px 20px;
                            border-radius: 8px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        `;
                        successMsg.textContent = 'âœ… å“ç›®ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼';
                        document.body.appendChild(successMsg);
                        
                        setTimeout(() => {
                            successMsg.remove();
                        }, 3000);
                        
                    } else {
                        throw new Error(result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
                    }
                    
                } catch (error) {
                    console.error('APIè¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                    hideLoading();
                    alert('âŒ å“ç›®è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            }
            
            // Google Apps Scriptã§å“ç›®æ›´æ–°
            async function updateItemInAPI(itemId, updates) {
                showLoading('å“ç›®ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™...');
                try {
                    if (!gasUrl) {
                        throw new Error('Google Apps Script URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    }

                    const formData = new FormData();
                    formData.append('action', 'updateItem');
                    formData.append('id', itemId);
                    Object.keys(updates).forEach(key => {
                        formData.append(key, updates[key]);
                    });

                    const response = await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'cors',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        await loadItemsFromAPI();
                        hideLoading();
                        return true;
                    } else {
                        throw new Error(result.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    console.error('APIæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    hideLoading();
                    alert('âŒ å“ç›®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                    return false;
                }
            }

            // å“ç›®ã®å‡¦åˆ†æ–¹æ³•ã‚’æ›´æ–°
            async function updateItemHandlingInAPI(itemId, handlingData) {
                showLoading('å‡¦åˆ†æ–¹æ³•ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™...');
                try {
                    if (!gasUrl) {
                        throw new Error('Google Apps Script URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    }

                    const formData = new FormData();
                    formData.append('action', 'updateHandling');
                    formData.append('id', itemId);
                    formData.append('handling', handlingData.handling);
                    formData.append('destination', handlingData.destination || '');

                    const response = await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'cors',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        await loadItemsFromAPI();
                        hideLoading();
                        return true;
                    } else {
                        throw new Error(result.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    console.error('å‡¦åˆ†æ–¹æ³•æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    hideLoading();
                    alert('âŒ å‡¦åˆ†æ–¹æ³•æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                    return false;
                }
            }

            // å‡¦åˆ†æ–¹æ³•æ±ºå®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆé¸æŠè§£é™¤æ©Ÿèƒ½ä»˜ãï¼‰
            function showHandlingModal(item) {
                const modalHtml = `
                    <div class="modal-overlay" id="handlingModal" style="
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                        background: rgba(0,0,0,0.8); display: flex; align-items: center;
                        justify-content: center; z-index: 9999;">
                        <div class="modal-content" style="
                            background: white; padding: 25px; border-radius: 12px;
                            max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <h3>ğŸ“‹ å‡¦åˆ†æ–¹æ³•ã‚’æ±ºå®š</h3>
                            <p><strong>å“ç›®:</strong> ${item.name}</p>
                            <p><strong>ç¾åœ¨ã®çŠ¶æ³:</strong> ${item.handling}${item.destination ? ' (' + item.destination + ')' : ''}</p>
                            
                            <div class="form-group">
                                <label>âš¡ æ–°ã—ã„å–æ‰±ã„æ–¹æ³•</label>
                                <div class="category-buttons" id="modalHandlingButtons">
                                    <button class="category-btn" data-value="å‡¦åˆ†">å‡¦åˆ†</button>
                                    <button class="category-btn" data-value="è­²æ¸¡">è­²æ¸¡</button>
                                    <button class="category-btn" data-value="é€ã‚Š">é€ã‚Š</button>
                                    <button class="category-btn" data-value="ä¿ç•™">ä¿ç•™</button>
                                </div>
                                <p class="toggle-hint">ğŸ’¡ åŒã˜ãƒœã‚¿ãƒ³ã‚’ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨é¸æŠè§£é™¤ã•ã‚Œã¾ã™</p>
                            </div>
                            
                            <div id="modalDestinationDiv" class="form-group hidden">
                                <label>è­²æ¸¡å…ˆ/é€ã‚Šå…ˆ</label>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px;" id="modalDestinationButtons">
                                    <button type="button" class="category-btn" data-value="å¯¾é¦¬">å¯¾é¦¬</button>
                                    <button type="button" class="category-btn" data-value="è¥¿æ–°">è¥¿æ–°</button>
                                    <button type="button" class="category-btn" data-value="ç¤¾é•·è‡ªå®…">ç¤¾é•·è‡ªå®…</button>
                                    <button type="button" class="category-btn" data-value="ãã®ä»–">ãã®ä»–</button>
                                </div>
                                <input type="text" id="modalDestination" placeholder="ãã®ä»–ã®å ´åˆã¯ç›´æ¥å…¥åŠ›" style="display: none;">
                                <p class="toggle-hint">ğŸ’¡ åŒã˜ãƒœã‚¿ãƒ³ã‚’ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨é¸æŠè§£é™¤ã•ã‚Œã¾ã™</p>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-success" id="saveHandlingBtn">ğŸ’¾ ä¿å­˜</button>
                                <button class="btn btn-danger" id="cancelHandlingBtn">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                let selectedHandling = '';
                let selectedDestination = '';
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®å–æ‰±ã„æ–¹æ³•é¸æŠï¼ˆé¸æŠè§£é™¤æ©Ÿèƒ½ä»˜ãï¼‰
                document.getElementById('modalHandlingButtons').addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-btn')) {
                        const clickedValue = e.target.dataset.value;
                        
                        // åŒã˜ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã¯é¸æŠè§£é™¤
                        if (selectedHandling === clickedValue) {
                            // é¸æŠè§£é™¤
                            e.target.classList.remove('active');
                            selectedHandling = '';
                            
                            // é€ã‚Šå…ˆé¸æŠã‚¨ãƒªã‚¢ã‚’éš ã™
                            const destinationDiv = document.getElementById('modalDestinationDiv');
                            destinationDiv.classList.add('hidden');
                            selectedDestination = '';
                            
                            // é€ã‚Šå…ˆãƒœã‚¿ãƒ³ã®é¸æŠã‚‚è§£é™¤
                            document.querySelectorAll('#modalDestinationButtons .category-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            document.getElementById('modalDestination').style.display = 'none';
                            
                        } else {
                            // ä»–ã®ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
                            document.querySelectorAll('#modalHandlingButtons .category-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            
                            // æ–°ã—ã„ãƒœã‚¿ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«
                            e.target.classList.add('active');
                            selectedHandling = clickedValue;
                            
                            const destinationDiv = document.getElementById('modalDestinationDiv');
                            if (selectedHandling === 'è­²æ¸¡' || selectedHandling === 'é€ã‚Š') {
                                destinationDiv.classList.remove('hidden');
                            } else {
                                destinationDiv.classList.add('hidden');
                                selectedDestination = '';
                                // é€ã‚Šå…ˆãƒœã‚¿ãƒ³ã®é¸æŠã‚‚è§£é™¤
                                document.querySelectorAll('#modalDestinationButtons .category-btn').forEach(btn => {
                                    btn.classList.remove('active');
                                });
                            }
                        }
                    }
                });
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®é€ã‚Šå…ˆé¸æŠï¼ˆé¸æŠè§£é™¤æ©Ÿèƒ½ä»˜ãï¼‰
                document.getElementById('modalDestinationButtons').addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-btn')) {
                        const clickedValue = e.target.dataset.value;
                        const destinationInput = document.getElementById('modalDestination');
                        
                        // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒœã‚¿ãƒ³ã‚’ç¢ºèª
                        const currentlySelected = document.querySelector('#modalDestinationButtons .category-btn.active');
                        const currentValue = currentlySelected ? currentlySelected.dataset.value : null;
                        
                        // åŒã˜ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã¯é¸æŠè§£é™¤
                        if (currentValue === clickedValue) {
                            // é¸æŠè§£é™¤
                            e.target.classList.remove('active');
                            destinationInput.style.display = 'none';
                            destinationInput.value = '';
                            selectedDestination = '';
                        } else {
                            // ä»–ã®ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
                            document.querySelectorAll('#modalDestinationButtons .category-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            
                            // æ–°ã—ã„ãƒœã‚¿ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«
                            e.target.classList.add('active');
                            
                            if (clickedValue === 'ãã®ä»–') {
                                destinationInput.style.display = 'block';
                                destinationInput.value = '';
                                destinationInput.focus();
                                selectedDestination = '';
                            } else {
                                destinationInput.style.display = 'none';
                                destinationInput.value = clickedValue;
                                selectedDestination = clickedValue;
                            }
                        }
                    }
                });
                
                // ãã®ä»–ã®å…¥åŠ›
                document.getElementById('modalDestination').addEventListener('input', function(e) {
                    selectedDestination = e.target.value;
                });
                
                // ä¿å­˜ãƒœã‚¿ãƒ³
                document.getElementById('saveHandlingBtn').addEventListener('click', async function() {
                    // é¸æŠè§£é™¤ã®å ´åˆã¯ã€Œæœªæ±ºå®šã€ã¨ã—ã¦ä¿å­˜
                    const finalHandling = selectedHandling || 'æœªæ±ºå®š';
                    const finalDestination = (selectedHandling === 'è­²æ¸¡' || selectedHandling === 'é€ã‚Š') ? 
                        selectedDestination : '';
                    
                    const success = await updateItemHandlingInAPI(item.id, {
                        handling: finalHandling,
                        destination: finalDestination
                    });
                    
                    if (success) {
                        document.getElementById('handlingModal').remove();
                        alert('âœ… å‡¦åˆ†æ–¹æ³•ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼');
                    }
                });
                
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
                document.getElementById('cancelHandlingBtn').addEventListener('click', function() {
                    document.getElementById('handlingModal').remove();
                });
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
                document.getElementById('handlingModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.remove();
                    }
                });
            }

            async function deleteItemFromAPI(itemId) {
                showLoading('å“ç›®ã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™...');
                try {
                    if (!gasUrl) {
                        throw new Error('Google Apps Script URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    }

                    const formData = new FormData();
                    formData.append('action', 'deleteItem');
                    formData.append('id', itemId);

                    const response = await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'cors',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        await loadItemsFromAPI();
                        hideLoading();
                        return true;
                    } else {
                        throw new Error(result.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    console.error('APIå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    hideLoading();
                    alert('âŒ å“ç›®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                    return false;
                }
            }

            // æ¥ç¶šãƒ†ã‚¹ãƒˆ
            async function testConnection() {
                const url = document.getElementById('gasUrl').value.trim();
                if (!url) {
                    alert('Google Apps Script URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                showLoading('æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...');
                try {
                    const response = await fetch(url + '?action=test', {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        gasUrl = url;
                        localStorage.setItem('gasUrl', url);
                        hideLoading();
                        alert('âœ… æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸï¼Google Apps Scriptã«æ¥ç¶šã§ãã¾ã—ãŸã€‚');
                        loadItemsFromAPI();
                    } else {
                        throw new Error(`æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }
                } catch (error) {
                    hideLoading();
                    alert('âŒ æ¥ç¶šãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            }

            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            function showError(message) {
                console.error(message);
                hideLoading();
                alert('ã‚¨ãƒ©ãƒ¼: ' + message);
            }

            function showLoading(message) {
                const existingOverlay = document.querySelector('.loading-overlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }

                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.innerHTML = '<div class="loading-spinner"></div><div>' + message + '</div>';
                document.body.appendChild(overlay);
                return overlay;
            }

            function hideLoading() {
                const overlay = document.querySelector('.loading-overlay');
                if (overlay) {
                    overlay.remove();
                }
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
            function setUser() {
                try {
                    const userSelect = document.getElementById('userSelect');
                    const username = userSelect.value;
                    
                    if (!username) {
                        alert('å…¥åŠ›è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    
                    currentUser = username;
                    
                    const userDiv = document.getElementById('currentUser');
                    userDiv.innerHTML = 'ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: <strong>' + username + '</strong> ã•ã‚“';
                    userDiv.classList.remove('hidden');
                    
                    alert('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œ' + username + 'ã€ã«è¨­å®šã•ã‚Œã¾ã—ãŸã€‚');
                } catch (error) {
                    showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            }
            
            // é«˜åœ§ç¸®ç”»åƒå‡¦ç†ï¼ˆã‚µã‚¤ã‚ºå¤§å¹…å‰Šæ¸›ï¼‰
            function processImageForMobile(file) {
                return new Promise((resolve, reject) => {
                    try {
                        const maxFileSize = 2 * 1024 * 1024; // 2MBã«åˆ¶é™
                        const maxResolution = 512; // 512pxã«ç¸®å°ï¼ˆã‚ˆã‚Šå°ã•ãï¼‰
                        const reader = new FileReader();

                        if (file.size > maxFileSize) {
                            reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ2MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰'));
                            return;
                        }

                        if (!file.type.startsWith('image/')) {
                            reject(new Error('æœ‰åŠ¹ãªç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'));
                            return;
                        }

                        reader.onload = function(event) {
                            const img = new Image();
                            img.onload = function() {
                                let width = img.width;
                                let height = img.height;
                                let ratio = width / height;

                                // ã‚ˆã‚Šç©æ¥µçš„ã«ã‚µã‚¤ã‚ºã‚’ç¸®å°
                                if (width > maxResolution || height > maxResolution) {
                                    if (width > height) {
                                        width = maxResolution;
                                        height = width / ratio;
                                    } else {
                                        height = maxResolution;
                                        width = height * ratio;
                                    }
                                }

                                const canvas = document.createElement('canvas');
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                
                                // ç”»è³ªã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®è¨­å®š
                                ctx.imageSmoothingEnabled = true;
                                ctx.imageSmoothingQuality = 'high';
                                ctx.drawImage(img, 0, 0, width, height);

                                // å¤§å¹…ã«åœ§ç¸®ï¼ˆå“è³ªã‚’40%ã«ä¸‹ã’ã‚‹ï¼‰
                                let quality = 0.4;
                                let compressedDataURL = canvas.toDataURL('image/jpeg', quality);
                                
                                // æœ€å¤§ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã‚’150KBã«åˆ¶é™
                                const maxDataSize = 150 * 1024; // 150KB
                                let attempts = 0;
                                
                                while (compressedDataURL.length > maxDataSize && quality > 0.1 && attempts < 5) {
                                    quality -= 0.1;
                                    compressedDataURL = canvas.toDataURL('image/jpeg', quality);
                                    attempts++;
                                }

                                console.log(`ç”»åƒåœ§ç¸®å®Œäº†: ${width}x${height}px, å“è³ª${Math.round(quality*100)}%, ã‚µã‚¤ã‚º: ${Math.round(compressedDataURL.length/1024)}KB`);
                                resolve(compressedDataURL);
                            };
                            img.src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    } catch (e) {
                        reject(e);
                    }
                });
            }

            // å“ç›®ä¸€è¦§ã®è¡¨ç¤º
            function displayItems() {
                const itemsList = document.getElementById('itemsList');
                itemsList.innerHTML = '';
                
                if (items.length === 0) {
                    itemsList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                items.forEach(item => {
                    const itemCard = document.createElement('div');
                    itemCard.className = `item-card ${item.completed ? 'completed' : ''}`;
                    itemCard.dataset.id = item.id;
                    
                    const itemHeader = document.createElement('div');
                    itemHeader.className = 'item-header';

                    if (item.photoUrl) {
                        const photo = document.createElement('img');
                        photo.src = item.photoUrl;
                        photo.className = 'item-photo';
                        photo.onerror = function() {
                            this.style.display = 'none';
                        };
                        itemHeader.appendChild(photo);
                    }
                    
                    const itemDetails = document.createElement('div');
                    itemDetails.className = 'item-details';
                    
                    // å–æ‰±ã„æ–¹æ³•ã®è¡¨ç¤ºã‚’æ”¹å–„
                    const handlingText = item.handling === 'æœªæ±ºå®š' ? 
                        '<span style="color: #dc3545; font-weight: bold;">âš ï¸ æ±ºå®šå¾…ã¡</span>' : 
                        `âš¡ ${item.handling}${item.destination ? ' (' + item.destination + ')' : ''}`;
                    
                    itemDetails.innerHTML = `
                        <h3>${item.name} (${item.count}å€‹)</h3>
                        <p style="font-size: 14px; color: #666;">
                            ğŸ·ï¸ ${item.category} | ${handlingText}
                        </p>
                        <p style="font-size: 12px; color: #888; margin-top: 5px;">
                            ç™»éŒ²è€…: ${item.addedBy}
                        </p>
                    `;
                    itemHeader.appendChild(itemDetails);

                    itemCard.appendChild(itemHeader);
                    
                    if (item.memo) {
                        const memo = document.createElement('p');
                        memo.style.cssText = 'font-size: 14px; margin-top: 10px; padding: 5px; background: #e9ecef; border-radius: 6px;';
                        memo.textContent = `å‚™è€ƒ: ${item.memo}`;
                        itemCard.appendChild(memo);
                    }

                    const controls = document.createElement('div');
                    controls.className = 'item-controls';
                    controls.innerHTML = `
                        <button class="btn btn-info btn-toggle-completed">
                            ${item.completed ? 'âœ… æ±ºå®šæ¸ˆã¿' : 'â˜‘ï¸ æ±ºå®šæ¸ˆã¿ã«ã™ã‚‹'}
                        </button>
                        <button class="btn btn-primary btn-edit-handling">
                            âœï¸ å‡¦åˆ†æ–¹æ³•ã‚’æ±ºå®š
                        </button>
                        <button class="btn btn-danger btn-delete-item">
                            ğŸ—‘ï¸ å‰Šé™¤
                        </button>
                    `;
                    itemCard.appendChild(controls);
                    
                    itemsList.appendChild(itemCard);
                });
            }

            // é›†è¨ˆæƒ…å ±ã®æ›´æ–°
            function updateSummary() {
                const totalCount = items.length;
                const completedCount = items.filter(item => item.completed).length;
                
                const categoryCounts = items.reduce((acc, item) => {
                    acc[item.category] = (acc[item.category] || 0) + 1;
                    return acc;
                }, {});

                const summaryCards = document.getElementById('summaryGrid').children;
                summaryCards[0].querySelector('h4').textContent = totalCount;
                summaryCards[1].querySelector('h4').textContent = completedCount;
                summaryCards[2].querySelector('h4').textContent = categoryCounts['å¨æˆ¿å™¨å…·'] || 0;
                summaryCards[3].querySelector('h4').textContent = categoryCounts['åº—å†…æ©Ÿæ'] || 0;
                summaryCards[4].querySelector('h4').textContent = categoryCounts['é£Ÿå™¨é¡'] || 0;
                summaryCards[5].querySelector('h4').textContent = categoryCounts['å‚™å“'] || 0;
            }

            // ã‚«ãƒ†ã‚´ãƒªãƒ»å–æ‰±ã„ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            function resetCategoryButtons() {
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                selectedCategory = '';
                selectedHandling = '';
                document.getElementById('destinationDiv').classList.add('hidden');
                document.getElementById('destination').value = '';
                document.getElementById('photoInput').value = '';
                document.getElementById('photoPreview').classList.add('hidden');
            }

            // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
            function exportToCSV() {
                if (items.length === 0) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }

                const headers = ['å“å', 'å€‹æ•°', 'å±æ€§', 'å–æ‰±ã„æ–¹æ³•', 'é€ã‚Šå…ˆ', 'æ±ºå®šæ¸ˆã¿', 'ç™»éŒ²è€…', 'ç™»éŒ²æ—¥æ™‚', 'ãƒ¡ãƒ¢'];
                const csvContent = [
                    headers.join(','),
                    ...items.map(item => [
                        `"${item.name}"`,
                        item.count,
                        `"${item.category}"`,
                        `"${item.handling}"`,
                        `"${item.destination}"`,
                        item.completed ? 'æ¸ˆ' : 'æœª',
                        `"${item.addedBy}"`,
                        `"${item.addedAt}"`,
                        `"${item.memo}"`
                    ].join(','))
                ].join('\n');

                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `å“ç›®ç®¡ç†_${new Date().toISOString().slice(0, 10)}.csv`;
                link.click();
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            document.addEventListener('DOMContentLoaded', function() {
                // ä¿å­˜ã•ã‚ŒãŸURLã‚’å¾©å…ƒ
                const savedUrl = localStorage.getItem('gasUrl');
                if (savedUrl) {
                    document.getElementById('gasUrl').value = savedUrl;
                    gasUrl = savedUrl;
                    loadItemsFromAPI();
                }

                // æ¥ç¶šãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
                document.getElementById('testConnectionBtn').addEventListener('click', testConnection);

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
                document.getElementById('setUserBtn').addEventListener('click', setUser);

                // ã‚«ãƒ†ã‚´ãƒªé¸æŠ
                document.getElementById('categoryButtons').addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-btn')) {
                        document.querySelectorAll('#categoryButtons .category-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        e.target.classList.add('active');
                        selectedCategory = e.target.dataset.value;
                    }
                });

                // å–æ‰±ã„æ–¹æ³•é¸æŠï¼ˆé¸æŠè§£é™¤æ©Ÿèƒ½ä»˜ãï¼‰
                document.getElementById('handlingButtons').addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-btn')) {
                        const clickedValue = e.target.dataset.value;
                        
                        // åŒã˜ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã¯é¸æŠè§£é™¤
                        if (selectedHandling === clickedValue) {
                            // é¸æŠè§£é™¤
                            e.target.classList.remove('active');
                            selectedHandling = '';
                            
                            // é€ã‚Šå…ˆé¸æŠã‚¨ãƒªã‚¢ã‚’éš ã™
                            document.getElementById('destinationDiv').classList.add('hidden');
                            document.getElementById('destination').value = '';
                            
                            // é€ã‚Šå…ˆãƒœã‚¿ãƒ³ã®é¸æŠã‚‚è§£é™¤
                            document.querySelectorAll('#destinationButtons .category-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            
                        } else {
                            // ä»–ã®ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
                            document.querySelectorAll('#handlingButtons .category-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            
                            // æ–°ã—ã„ãƒœã‚¿ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«
                            e.target.classList.add('active');
                            selectedHandling = clickedValue;
                            
                            // é€ã‚Šå…ˆãŒå¿…è¦ãªå ´åˆã¯è¡¨ç¤º
                            const destinationDiv = document.getElementById('destinationDiv');
                            if (selectedHandling === 'è­²æ¸¡' || selectedHandling === 'é€ã‚Š') {
                                destinationDiv.classList.remove('hidden');
                            } else {
                                destinationDiv.classList.add('hidden');
                                document.getElementById('destination').value = '';
                                // é€ã‚Šå…ˆãƒœã‚¿ãƒ³ã®é¸æŠã‚‚è§£é™¤
                                document.querySelectorAll('#destinationButtons .category-btn').forEach(btn => {
                                    btn.classList.remove('active');
                                });
                            }
                        }
                    }
                });

                // é€ã‚Šå…ˆé¸æŠï¼ˆé¸æŠè§£é™¤æ©Ÿèƒ½ä»˜ãï¼‰
                document.getElementById('destinationButtons').addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-btn')) {
                        const clickedValue = e.target.dataset.value;
                        const destinationInput = document.getElementById('destination');
                        
                        // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒœã‚¿ãƒ³ã‚’ç¢ºèª
                        const currentlySelected = document.querySelector('#destinationButtons .category-btn.active');
                        const currentValue = currentlySelected ? currentlySelected.dataset.value : null;
                        
                        // åŒã˜ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã¯é¸æŠè§£é™¤
                        if (currentValue === clickedValue) {
                            // é¸æŠè§£é™¤
                            e.target.classList.remove('active');
                            destinationInput.style.display = 'none';
                            destinationInput.value = '';
                        } else {
                            // ä»–ã®ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
                            document.querySelectorAll('#destinationButtons .category-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            
                            // æ–°ã—ã„ãƒœã‚¿ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«
                            e.target.classList.add('active');
                            
                            if (clickedValue === 'ãã®ä»–') {
                                destinationInput.style.display = 'block';
                                destinationInput.value = '';
                                destinationInput.focus();
                            } else {
                                destinationInput.style.display = 'none';
                                destinationInput.value = clickedValue;
                            }
                        }
                    }
                });

                // å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆåœ§ç¸®æƒ…å ±è¡¨ç¤ºå¼·åŒ–ï¼‰
                document.getElementById('photoInput').addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const preview = document.getElementById('photoPreview');
                        const previewImage = document.getElementById('previewImage');
                        const compressionInfo = document.getElementById('compressionInfo');
                        
                        // å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
                        const originalSizeKB = Math.round(file.size / 1024);
                        compressionInfo.innerHTML = `<span style="color: #666;">å‡¦ç†ä¸­... å…ƒãƒ•ã‚¡ã‚¤ãƒ«: ${originalSizeKB}KB</span>`;
                        preview.classList.remove('hidden');
                        
                        try {
                            // ç”»åƒã‚’åœ§ç¸®å‡¦ç†
                            const compressedDataURL = await processImageForMobile(file);
                            previewImage.src = compressedDataURL;
                            
                            // åœ§ç¸®å¾Œã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
                            const compressedSizeKB = Math.round(compressedDataURL.length / 1024);
                            const compressionRatio = Math.round((1 - compressedSizeKB / originalSizeKB) * 100);
                            
                            compressionInfo.innerHTML = `
                                <span style="color: #28a745; font-weight: bold;">âœ… åœ§ç¸®å®Œäº†</span><br>
                                <small>å…ƒãƒ•ã‚¡ã‚¤ãƒ«: ${originalSizeKB}KB â†’ åœ§ç¸®å¾Œ: ${compressedSizeKB}KB (${compressionRatio}% å‰Šæ¸›)</small>
                            `;
                        } catch (error) {
                            compressionInfo.innerHTML = `<span style="color: #dc3545;">âŒ åœ§ç¸®ã‚¨ãƒ©ãƒ¼: ${error.message}</span>`;
                        }
                    }
                });

                // å“ç›®è¿½åŠ ãƒœã‚¿ãƒ³
                document.getElementById('addItemBtn').addEventListener('click', async function() {
                    if (!currentUser) {
                        alert('ã¾ãšã€å…¥åŠ›è€…åã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    if (!gasUrl) {
                        alert('Google Apps Script URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    const itemName = document.getElementById('itemName').value.trim();
                    const itemCount = parseInt(document.getElementById('itemCount').value);
                    const itemMemo = document.getElementById('itemMemo').value.trim();

                    if (!itemName) {
                        alert('å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    // å–æ‰±ã„æ–¹æ³•ã¨å±æ€§ã¯å¿…é ˆã§ã¯ãªã„ï¼ˆæœªé¸æŠã§ã‚‚OKï¼‰
                    const finalCategory = selectedCategory || 'æœªåˆ†é¡';
                    const finalHandling = selectedHandling || 'æœªæ±ºå®š';
                    
                    const destinationInput = document.getElementById('destination');
                    const finalDestination = (selectedHandling === 'è­²æ¸¡' || selectedHandling === 'é€ã‚Š') ? 
                        (destinationInput.value || destinationInput.placeholder) : '';
                    
                    let photoDataUrl = null;
                    const photoInput = document.getElementById('photoInput');
                    if (photoInput.files.length > 0) {
                        try {
                            photoDataUrl = await processImageForMobile(photoInput.files[0]);
                        } catch (error) {
                            alert(error.message);
                            return;
                        }
                    }

                    const newItem = {
                        name: itemName,
                        count: itemCount,
                        category: finalCategory,
                        handling: finalHandling,
                        destination: finalDestination,
                        addedBy: currentUser,
                        memo: itemMemo,
                        photoDataUrl: photoDataUrl
                    };

                    await addItemToAPI(newItem);
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                    document.getElementById('itemName').value = '';
                    document.getElementById('itemCount').value = '1';
                    document.getElementById('itemMemo').value = '';
                    resetCategoryButtons();
                });

                // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒœã‚¿ãƒ³
                document.getElementById('refreshBtn').addEventListener('click', loadItemsFromAPI);

                // Google Sheetsã§ç¢ºèªãƒœã‚¿ãƒ³
                document.getElementById('openSheetsBtn').addEventListener('click', function() {
                    // ç›´æ¥ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’é–‹ã
                    const spreadsheetUrl = 'https://docs.google.com/spreadsheets/d/1vB-ymJZ2OSccz-3S5peH75B1ccriXDMfqJLrLXdX3JQ/edit';
                    window.open(spreadsheetUrl, '_blank');
                });

                // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³
                document.getElementById('exportBtn').addEventListener('click', exportToCSV);

                // ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ±ºå®šæ¸ˆã¿åˆ‡ã‚Šæ›¿ãˆã€å‡¦åˆ†æ–¹æ³•æ±ºå®šã€å‰Šé™¤ï¼‰
                document.addEventListener('click', async function(e) {
                    if (e.target.classList.contains('btn-toggle-completed')) {
                        const itemCard = e.target.closest('.item-card');
                        const itemId = itemCard.dataset.id;
                        const item = items.find(item => item.id === itemId);
                        
                        if (item && gasUrl) {
                            const newCompletedStatus = !item.completed;
                            const success = await updateItemInAPI(itemId, { 
                                completed: newCompletedStatus 
                            });
                            
                            if (success) {
                                // ãƒ­ãƒ¼ã‚«ãƒ«ã®çŠ¶æ…‹ã‚‚æ›´æ–°
                                item.completed = newCompletedStatus;
                                displayItems();
                                updateSummary();
                            }
                        }
                    }
                    
                    if (e.target.classList.contains('btn-edit-handling')) {
                        const itemCard = e.target.closest('.item-card');
                        const itemId = itemCard.dataset.id;
                        const item = items.find(item => item.id === itemId);
                        
                        if (item) {
                            showHandlingModal(item);
                        }
                    }
                    
                    if (e.target.classList.contains('btn-delete-item')) {
                        const itemCard = e.target.closest('.item-card');
                        const itemId = itemCard.dataset.id;
                        const item = items.find(item => item.id === itemId);
                        
                        if (item && gasUrl) {
                            // ç¢ºèªãªã—ã§å³åº§ã«å‰Šé™¤
                            const success = await deleteItemFromAPI(itemId);
                            if (success) {
                                // ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚‚å‰Šé™¤
                                const index = items.findIndex(item => item.id === itemId);
                                if (index > -1) {
                                    items.splice(index, 1);
                                }
                                displayItems();
                                updateSummary();
                            }
                        }
                    }
                });
            });

        })();
    </script>
</body>
</html>
