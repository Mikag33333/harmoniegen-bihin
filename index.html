<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç¢„É´„É¢„Éã„ÉºÁéÑ Ê©üÊùê„ÉªÂÇôÂìÅÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        /* CSS„ÅØÂ§âÊõ¥„Å™„Åó */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .database-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .database-status.connected {
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid #28a745;
            color: #155724;
        }

        .database-status.disconnected {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid #dc3545;
            color: #721c24;
        }

        .database-status.connecting {
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid #ffc107;
            color: #856404;
        }

        .gas-url-section {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .gas-url-section h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .main-content {
            padding: 20px;
        }
        
        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #20c997);
            color: white;
        }
        
        .btn:hover, .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .category-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin: 10px 0;
        }
        
        .category-btn {
            padding: 12px 8px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
            touch-action: manipulation;
            font-size: 14px;
        }
        
        .category-btn:hover, .category-btn:active {
            background: #f8f9fa;
        }
        
        .category-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }
        
        .item-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            position: relative;
        }
        
        .item-card.completed {
            border-color: #28a745;
            background: #f8fff9;
        }

        .item-card.syncing {
            border-color: #ffc107;
            background: #fff8e1;
        }

        .item-card.syncing::after {
            content: "üîÑ ÂêåÊúü‰∏≠...";
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffc107;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .item-card:hover, .item-card:active {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .item-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            flex-direction: column;
        }
        
        @media (min-width: 500px) {
            .item-header {
                flex-direction: row;
                align-items: center;
            }
        }
        
        .item-photo {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #ddd;
            margin-bottom: 10px;
        }
        
        @media (min-width: 500px) {
            .item-photo {
                width: 100px;
                height: 100px;
                margin-right: 15px;
                margin-bottom: 0;
            }
        }
        
        .item-details {
            flex: 1;
        }
        
        .item-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .summary-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .summary-card {
            background: rgba(255,255,255,0.1);
            padding: 15px 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-card h4 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        
        .summary-card p {
            font-size: 0.9em;
        }
        
        .user-info {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .hidden {
            display: none !important;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
            flex-direction: column;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toggle-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .section {
                padding: 15px;
            }
            
            .category-buttons {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 6px;
            }
            
            .category-btn {
                padding: 10px 6px;
                font-size: 13px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è „Ç¢„É´„É¢„Éã„ÉºÁéÑ</h1>
            <p>Ê©üÊùê„ÉªÂÇôÂìÅÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†ÔºàGoogle SheetsÁâàÔºâ</p>
        </div>
        
        <div class="main-content">
            <!-- Google Apps Script URLË®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="gas-url-section">
                <h4>‚öôÔ∏è Google Apps Script URLË®≠ÂÆö</h4>
                <div class="form-group">
                    <label>Google Apps Script „Ç¶„Çß„Éñ„Ç¢„Éó„É™URL</label>
                    <input type="url" id="gasUrl" placeholder="https://script.google.com/macros/s/.../exec" 
                           value="https://script.google.com/macros/s/AKfycbyS16NIjTSXfXQnl6AgU-TfqjUuyCJQvj3ubeTTro_VJWG_kMb_rfMxhqljqH0hg0fA/exec">
                    <small style="color: #666; font-size: 12px;">
                        Google Apps Script„Åß‰ΩúÊàê„Åó„Åü„Ç¶„Çß„Éñ„Ç¢„Éó„É™„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                    </small>
                </div>
                <button class="btn btn-primary" id="testConnectionBtn">Êé•Á∂ö„ÉÜ„Çπ„Éà</button>
            </div>

            <div id="databaseStatus" class="database-status connecting">
                üü° „Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...
            </div>
            
            <div class="section">
                <h3>üë§ ÂÖ•ÂäõËÄÖË®≠ÂÆö</h3>
                <div class="form-group">
                    <label>ÂÖ•ÂäõËÄÖÂêç„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</label>
                    <select id="userSelect">
                        <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        <option value="‰∏â„É∂Â∞ª">‰∏â„É∂Â∞ª</option>
                        <option value="Ê°Ç">Ê°Ç</option>
                        <option value="ÈòøÊØîÁïô">ÈòøÊØîÁïô</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="setUserBtn">Ë®≠ÂÆö</button>
                <div id="currentUser" class="user-info hidden"></div>
            </div>
            
            <div class="section">
                <h3>üìù Êñ∞„Åó„ÅÑÂìÅÁõÆ„ÇíËøΩÂä†</h3>
                
                <div class="form-group">
                    <label>üì∑ ÂÜôÁúü„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ <span style="color: #6c757d; font-size: 14px;">(„Ç™„Éó„Ç∑„Éß„É≥)</span></label>
                    <input type="file" id="photoInput" accept="image/*" capture="environment">
                    <div id="photoPreview" class="hidden" style="margin-top: 10px;">
                        <img id="previewImage" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid #ddd;">
                        <p id="compressionInfo" style="font-size: 12px; color: #6c757d; margin-top: 5px;"></p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>üìã ÂìÅÂêç</label>
                    <input type="text" id="itemName" placeholder="ÂìÅÁõÆÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
                </div>
                
                <div class="form-group">
                    <label>üî¢ ÂÄãÊï∞</label>
                    <input type="number" id="itemCount" value="1" min="1">
                </div>

                <div class="form-group">
                    <label>üìù „É°„É¢„ÉªÂÇôËÄÉ</label>
                    <input type="text" id="itemMemo" placeholder="„Çµ„Ç§„Ç∫„ÄÅÁä∂ÊÖã„ÄÅÁâπË®ò‰∫ãÈ†Ö„Å™„Å©Ôºà‰ªªÊÑèÔºâ">
                </div>
                
                <div class="form-group">
                    <label>üè∑Ô∏è Â±ûÊÄß„ÇíÈÅ∏Êäû <span style="color: #6c757d; font-size: 14px;">(Âæå„ÅßÂ§âÊõ¥ÂèØËÉΩ)</span></label>
                    <div class="category-buttons" id="categoryButtons">
                        <button class="category-btn" data-value="Âé®ÊàøÂô®ÂÖ∑">Âé®ÊàøÂô®ÂÖ∑</button>
                        <button class="category-btn" data-value="Â∫óÂÜÖÊ©üÊùê">Â∫óÂÜÖÊ©üÊùê</button>
                        <button class="category-btn" data-value="È£üÂô®È°û">È£üÂô®È°û</button>
                        <button class="category-btn" data-value="ÂÇôÂìÅ">ÂÇôÂìÅ</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>‚ö° ÂèñÊâ±„ÅÑÊñπÊ≥ï <span style="color: #6c757d; font-size: 14px;">(Á§æÈï∑„ÅåÂæå„ÅßÊ±∫ÂÆö)</span></label>
                    <div class="category-buttons" id="handlingButtons">
                        <button class="category-btn" data-value="Âá¶ÂàÜ">Âá¶ÂàÜ</button>
                        <button class="category-btn" data-value="Ë≠≤Ê∏°">Ë≠≤Ê∏°</button>
                        <button class="category-btn" data-value="ÈÄÅ„Çä">ÈÄÅ„Çä</button>
                        <button class="category-btn" data-value="‰øùÁïô">‰øùÁïô</button>
                    </div>
                    <p class="toggle-hint">üí° Âêå„Åò„Éú„Çø„É≥„Çí„ÇÇ„ÅÜ‰∏ÄÂ∫¶Êäº„Åô„Å®ÈÅ∏ÊäûËß£Èô§„Åï„Çå„Åæ„Åô</p>
                    <div id="destinationDiv" class="form-group hidden">
                        <label>Ë≠≤Ê∏°ÂÖà/ÈÄÅ„ÇäÂÖà</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px;" id="destinationButtons">
                            <button type="button" class="category-btn" data-value="ÂØæÈ¶¨">ÂØæÈ¶¨</button>
                            <button type="button" class="category-btn" data-value="Ë•øÊñ∞">Ë•øÊñ∞</button>
                            <button type="button" class="category-btn" data-value="Á§æÈï∑Ëá™ÂÆÖ">Á§æÈï∑Ëá™ÂÆÖ</button>
                            <button type="button" class="category-btn" data-value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</button>
                        </div>
                        <input type="text" id="destination" placeholder="„Åù„ÅÆ‰ªñ„ÅÆÂ†¥Âêà„ÅØÁõ¥Êé•ÂÖ•Âäõ" style="display: none;">
                        <p class="toggle-hint">üí° Âêå„Åò„Éú„Çø„É≥„Çí„ÇÇ„ÅÜ‰∏ÄÂ∫¶Êäº„Åô„Å®ÈÅ∏ÊäûËß£Èô§„Åï„Çå„Åæ„Åô</p>
                    </div>
                </div>
                
                <button class="btn btn-success" id="addItemBtn">ÂìÅÁõÆ„ÇíËøΩÂä†</button>
                <p id="addItemStatus" style="font-size: 14px; color: #666; margin-top: 5px;">
                    ‚úÖ Êé•Á∂öÊ∏à„Åø
                </p>
            </div>
            
            <div class="section">
                <h3>üì¶ ÁôªÈå≤Ê∏à„ÅøÂìÅÁõÆ‰∏ÄË¶ß</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="btn btn-info" id="refreshBtn">üîÑ ÊúÄÊñ∞„Éá„Éº„Çø„ÇíÂèñÂæó</button>
                    <button class="btn btn-primary" id="openSheetsBtn">üìä Google Sheets„ÅßÁ¢∫Ë™ç</button>
                </div>
                <div id="itemsList">
                    <p style="text-align: center; color: #6c757d; padding: 40px;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                </div>
            </div>
            
            <div class="summary-section">
                <h3>üìä ÈõÜË®àÊÉÖÂ†±</h3>
                <div class="summary-grid" id="summaryGrid">
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>Á∑èÂìÅÁõÆÊï∞</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>Ê±∫ÂÆöÊ∏à„Åø</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>Âé®ÊàøÂô®ÂÖ∑</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>Â∫óÂÜÖÊ©üÊùê</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>È£üÂô®È°û</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>ÂÇôÂìÅ</p>
                    </div>
                </div>
                <button class="btn btn-success" id="exportBtn">üìÑ CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
            </div>
        </div>
    </div>
    
    <script>
        (function() {
            'use strict';
            
            let currentUser = '';
            let items = [];
            let selectedCategory = '';
            let selectedHandling = '';
            let gasUrl = '';
            
            // Êé•Á∂öÁä∂ÊÖã„ÅÆÊõ¥Êñ∞
            function updateConnectionStatus(status) {
                const statusDiv = document.getElementById('databaseStatus');
                statusDiv.className = 'database-status ' + status;
                
                switch(status) {
                    case 'connected':
                        statusDiv.innerHTML = 'üü¢ Google SheetsÊé•Á∂öÊ∏à„Åø - „Éá„Éº„ÇøÂêåÊúüÂèØËÉΩ';
                        break;
                    case 'connecting':
                        statusDiv.innerHTML = 'üü° „Éá„Éº„ÇøÂêåÊúü‰∏≠...';
                        break;
                    case 'disconnected':
                        statusDiv.innerHTML = 'üî¥ Êé•Á∂ö„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                        break;
                }
            }
            
            // Google Apps Script„Åã„Çâ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
            async function loadItemsFromAPI() {
                updateConnectionStatus('connecting');
                try {
                    if (!gasUrl) {
                        throw new Error('Google Apps Script URL„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    }

                    const response = await fetch(gasUrl + '?action=getItems', {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Google Apps Script„Åã„Çâ„ÅÆ„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Google Apps Script„Åã„Çâ„ÅÆÈÖçÂàó„Éá„Éº„Çø„ÇíÂá¶ÁêÜ
                    if (Array.isArray(data)) {
                        items = data.map((item, index) => ({
                            id: item.id || item['ID'] || `item_${index}`,
                            name: item.name || item['ÂìÅÂêç'] || '',
                            count: parseInt(item.count || item['ÂÄãÊï∞']) || 1,
                            category: item.category || item['Â±ûÊÄß'] || 'ÂÇôÂìÅ',
                            handling: item.handling || item['ÂèñÊâ±„ÅÑÊñπÊ≥ï'] || 'Êú™Ê±∫ÂÆö',
                            destination: item.destination || item['ÈÄÅ„ÇäÂÖà'] || '',
                            completed: item.completed === true || item.completed === 'true' || item['Ê±∫ÂÆöÊ∏à„Åø'] === true || item['Ê±∫ÂÆöÊ∏à„Åø'] === 'true',
                            addedBy: item.addedBy || item['ÁôªÈå≤ËÄÖ'] || '',
                            addedAt: item.addedAt || item['ÁôªÈå≤Êó•ÊôÇ'] || '',
                            memo: item.memo || item['„É°„É¢'] || '',
                            photoUrl: item.photoUrl || item['ÂÜôÁúüURL'] || null
                        }));
                    } else {
                        items = [];
                    }

                    displayItems();
                    updateSummary();
                    updateConnectionStatus('connected');
                    console.log('Google Apps Script„Åã„Çâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü:', items.length, '‰ª∂');
                } catch (error) {
                    console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    updateConnectionStatus('disconnected');
                    alert('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }
            
            // Google Apps Script„Å´ÂìÅÁõÆËøΩÂä†ÔºàÊúÄÈÅ©ÂåñÁâàÔºâ
            async function addItemToAPI(item) {
                const loadingOverlay = showLoading('ÂìÅÁõÆ„ÇíËøΩÂä†„Åó„Å¶„ÅÑ„Åæ„Åô...');
                try {
                    if (!gasUrl) {
                        throw new Error('Google Apps Script URL„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    }

                    // „Éï„Ç©„Éº„É†„Éá„Éº„Çø„ÇíÂäπÁéáÁöÑ„Å´‰ΩúÊàê
                    const formData = new FormData();
                    const formFields = {
                        action: 'addItem',
                        name: item.name,
                        count: item.count.toString(),
                        category: item.category,
                        handling: item.handling,
                        destination: item.destination || '',
                        addedBy: item.addedBy,
                        memo: item.memo || '',
                        photoDataUrl: item.photoDataUrl || ''
                    };

                    // ‰∏ÄÊã¨„Åß„Éï„Ç©„Éº„É†„Éá„Éº„Çø„Å´ËøΩÂä†
                    Object.entries(formFields).forEach(([key, value]) => {
                        formData.append(key, value);
                    });

                    console.log('ÈÄÅ‰ø°„Éá„Éº„Çø„Çµ„Ç§„Ç∫:', item.photoDataUrl ? `${Math.round(item.photoDataUrl.length/1024)}KB` : '0KB');

                    const startTime = Date.now();
                    const response = await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'cors',
                        body: formData
                    });
                    const endTime = Date.now();
                    
                    console.log(`APIÂëº„Å≥Âá∫„ÅóÊôÇÈñì: ${endTime - startTime}ms`);

                    if (!response.ok) {
                        throw new Error(`ËøΩÂä†„Ç®„É©„Éº: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    if (result.success) {
                        // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫„ÇíÊõ¥Êñ∞
                        loadingOverlay.innerHTML = '<div class="loading-spinner"></div><div>„Éá„Éº„Çø„ÇíÊõ¥Êñ∞‰∏≠...</div>';
                        
                        await loadItemsFromAPI();
                        hideLoading();
                        
                        // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                        const successMsg = document.createElement('div');
                        successMsg.style.cssText = `
                            position: fixed; top: 20px; right: 20px; z-index: 10000;
                            background: #28a745; color: white; padding: 15px 20px;
                            border-radius: 8px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        `;
                        successMsg.textContent = '‚úÖ ÂìÅÁõÆ„ÅåËøΩÂä†„Åï„Çå„Åæ„Åó„ÅüÔºÅ';
                        document.body.appendChild(successMsg);
                        
                        setTimeout(() => {
                            successMsg.remove();
                        }, 3000);
                        
                    } else {
                        throw new Error(result.error || '‰∏çÊòé„Å™„Ç®„É©„Éº');
                    }
                    
                } catch (error) {
                    console.error('APIËøΩÂä†„Ç®„É©„Éº:', error);
                    hideLoading();
                    alert('‚ùå ÂìÅÁõÆËøΩÂä†‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }
            
            // Google Apps Script„ÅßÂìÅÁõÆÊõ¥Êñ∞
            async function updateItemInAPI(itemId, updates) {
                showLoading('ÂìÅÁõÆ„ÇíÊõ¥Êñ∞„Åó„Å¶„ÅÑ„Åæ„Åô...');
                try {
                    if (!gasUrl) {
                        throw new Error('Google Apps Script URL„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    }

                    const formData = new FormData();
                    formData.append('action', 'updateItem');
                    formData.append('id', itemId);
                    Object.keys(updates).forEach(key => {
                        formData.append(key, updates[key]);
                    });

                    const response = await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'cors',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Êõ¥Êñ∞„Ç®„É©„Éº: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        await loadItemsFromAPI();
                        hideLoading();
                        return true;
                    } else {
                        throw new Error(result.error || 'Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                } catch (error) {
                    console.error('APIÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                    hideLoading();
                    alert('‚ùå ÂìÅÁõÆÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                    return false;
                }
            }

            // ÂìÅÁõÆ„ÅÆÂá¶ÂàÜÊñπÊ≥ï„ÇíÊõ¥Êñ∞
            async function updateItemHandlingInAPI(itemId, handlingData) {
                showLoading('Âá¶ÂàÜÊñπÊ≥ï„ÇíÊõ¥Êñ∞„Åó„Å¶„ÅÑ„Åæ„Åô...');
                try {
                    if (!gasUrl) {
                        throw new Error('Google Apps Script URL„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    }

                    const formData = new FormData();
                    formData.append('action', 'updateHandling');
                    formData.append('id', itemId);
                    formData.append('handling', handlingData.handling);
                    formData.append('destination', handlingData.destination || '');

                    const response = await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'cors',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Êõ¥Êñ∞„Ç®„É©„Éº: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        await loadItemsFromAPI();
                        hideLoading();
                        return true;
                    } else {
                        throw new Error(result.error || 'Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                } catch (error) {
                    console.error('Âá¶ÂàÜÊñπÊ≥ïÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                    hideLoading();
                    alert('‚ùå Âá¶ÂàÜÊñπÊ≥ïÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                    return false;
                }
            }

            // Âá¶ÂàÜÊñπÊ≥ïÊ±∫ÂÆö„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫ÔºàÈÅ∏ÊäûËß£Èô§Ê©üËÉΩ‰ªò„ÅçÔºâ
            function showHandlingModal(item) {
                const modalHtml = `
                    <div class="modal-overlay" id="handlingModal" style="
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                        background: rgba(0,0,0,0.8); display: flex; align-items: center;
                        justify-content: center; z-index: 9999;">
                        <div class="modal-content" style="
                            background: white; padding: 25px; border-radius: 12px;
                            max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <h3>üìã Âá¶ÂàÜÊñπÊ≥ï„ÇíÊ±∫ÂÆö</h3>
                            <p><strong>ÂìÅÁõÆ:</strong> ${item.name}</p>
                            <p><strong>ÁèæÂú®„ÅÆÁä∂Ê≥Å:</strong> ${item.handling}${item.destination ? ' (' + item.destination + ')' : ''}</p>
                            
                            <div class="form-group">
                                <label>‚ö° Êñ∞„Åó„ÅÑÂèñÊâ±„ÅÑÊñπÊ≥ï</label>
                                <div class="category-buttons" id="modalHandlingButtons">
                                    <button class="category-btn" data-value="Âá¶ÂàÜ">Âá¶ÂàÜ</button>
                                    <button class="category-btn" data-value="Ë≠≤Ê∏°">Ë≠≤Ê∏°</button>
                                    <button class="category-btn" data-value="ÈÄÅ„Çä">ÈÄÅ„Çä</button>
                                    <button class="category-btn" data-value="‰øùÁïô">‰øùÁïô</button>
                                </div>
                                <p class="toggle-hint">üí° Âêå„Åò„Éú„Çø„É≥„Çí„ÇÇ„ÅÜ‰∏ÄÂ∫¶Êäº„Åô„Å®ÈÅ∏ÊäûËß£Èô§„Åï„Çå„Åæ„Åô</p>
                            </div>
                            
                            <div id="modalDestinationDiv" class="form-group hidden">
                                <label>Ë≠≤Ê∏°ÂÖà/ÈÄÅ„ÇäÂÖà</label>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px;" id="modalDestinationButtons">
                                    <button type="button" class="category-btn" data-value="ÂØæÈ¶¨">ÂØæÈ¶¨</button>
                                    <button type="button" class="category-btn" data-value="Ë•øÊñ∞">Ë•øÊñ∞</button>
                                    <button type="button" class="category-btn" data-value="Á§æÈï∑Ëá™ÂÆÖ">Á§æÈï∑Ëá™ÂÆÖ</button>
                                    <button type="button" class="category-btn" data-value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</button>
                                </div>
                                <input type="text" id="modalDestination" placeholder="„Åù„ÅÆ‰ªñ„ÅÆÂ†¥Âêà„ÅØÁõ¥Êé•ÂÖ•Âäõ" style="display: none;">
                                <p class="toggle-hint">üí° Âêå„Åò„Éú„Çø„É≥„Çí„ÇÇ„ÅÜ‰∏ÄÂ∫¶Êäº„Åô„Å®ÈÅ∏ÊäûËß£Èô§„Åï„Çå„Åæ„Åô</p>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-success" id="saveHandlingBtn">üíæ ‰øùÂ≠ò</button>
                                <button class="btn btn-danger" id="cancelHandlingBtn">‚ùå „Ç≠„É£„É≥„Çª„É´</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                let selectedHandling = '';
                let selectedDestination = '';
                
                // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆÂèñÊâ±„ÅÑÊñπÊ≥ïÈÅ∏ÊäûÔºàÈÅ∏ÊäûËß£Èô§Ê©üËÉΩ‰ªò„ÅçÔºâ
                document.getElementById('modalHandlingButtons').addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-btn')) {
                        const clickedValue = e.target.dataset.value;
                        
                        // Âêå„Åò„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà„ÅØÈÅ∏ÊäûËß£Èô§
                        if (selectedHandling === clickedValue) {
                            // ÈÅ∏ÊäûËß£Èô§
                            e.target.classList.remove('active');
                            selectedHandling = '';
                            
                            // ÈÄÅ„ÇäÂÖàÈÅ∏Êäû„Ç®„É™„Ç¢„ÇíÈö†„Åô
                            const destinationDiv = document.getElementById('modalDestinationDiv');
                            destinationDiv.classList.add('hidden');
                            selectedDestination = '';
                            
                            // ÈÄÅ„ÇäÂÖà„Éú„Çø„É≥„ÅÆÈÅ∏Êäû„ÇÇËß£Èô§
                            document.querySelectorAll('#modalDestinationButtons .category-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            document.getElementById('modalDestination').style.display = 'none';
                            
                        } else {
                            // ‰ªñ„ÅÆ„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢
                            document.querySelectorAll('#modalHandlingButtons .category-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            
                            // Êñ∞„Åó„ÅÑ„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´
                            e.target.classList.add('active');
                            selectedHandling = clickedValue;
                            
                            const destinationDiv = document.getElementById('modalDestinationDiv');
                            if (selectedHandling === 'Ë≠≤Ê∏°' || selectedHandling === 'ÈÄÅ„Çä') {
                                destinationDiv.classList.remove('hidden');
                            } else {
                                destinationDiv.classList.add('hidden');
                                selectedDestination = '';
                                // ÈÄÅ„ÇäÂÖà„Éú„Çø„É≥„ÅÆÈÅ∏Êäû„ÇÇËß£Èô§
                                document.querySelectorAll('#modalDestinationButtons .category-btn').forEach(btn => {
                                    btn.classList.remove('active');
                                });
                            }
                        }
                    }
                });
                
                // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆÈÄÅ„ÇäÂÖàÈÅ∏ÊäûÔºàÈÅ∏ÊäûËß£Èô§Ê©üËÉΩ‰ªò„ÅçÔºâ
                document.getElementById('modalDestinationButtons').addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-btn')) {
                        const clickedValue = e.target.dataset.value;
                        const destinationInput = document.getElementById('modalDestination');
                        
                        // ÁèæÂú®ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Éú„Çø„É≥„ÇíÁ¢∫Ë™ç
                        const currentlySelected = document.querySelector('#modalDestinationButtons .category-btn.active');
                        const currentValue = currentlySelected ? currentlySelected.dataset.value : null;
                        
                        // Âêå„Åò„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà„ÅØÈÅ∏ÊäûËß£Èô§
                        if (currentValue === clickedValue) {
                            // ÈÅ∏ÊäûËß£Èô§
                            e.target.classList.remove('active');
                            destinationInput.style.display = 'none';
                            destinationInput.value = '';
                            selectedDestination = '';
                        } else {
                            // ‰ªñ„ÅÆ„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢
                            document.querySelectorAll('#modalDestinationButtons .category-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            
                            // Êñ∞„Åó„ÅÑ„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´
                            e.target.classList.add('active');
                            
                            if (clickedValue === '„Åù„ÅÆ‰ªñ') {
                                destinationInput.style.display = 'block';
                                destinationInput.value = '';
                                destinationInput.focus();
                                selectedDestination = '';
                            } else {
                                destinationInput.style.display = 'none';
                                destinationInput.value = clickedValue;
                                selectedDestination = clickedValue;
                            }
                        }
                    }
                });
                
                // „Åù„ÅÆ‰ªñ„ÅÆÂÖ•Âäõ
                document.getElementById('modalDestination').addEventListener('input', function(e) {
                    selectedDestination = e.target.value;
                });
                
                // ‰øùÂ≠ò„Éú„Çø„É≥
                document.getElementById('saveHandlingBtn').addEventListener('click', async function() {
                    // ÈÅ∏ÊäûËß£Èô§„ÅÆÂ†¥Âêà„ÅØ„ÄåÊú™Ê±∫ÂÆö„Äç„Å®„Åó„Å¶‰øùÂ≠ò
                    const finalHandling = selectedHandling || 'Êú™Ê±∫ÂÆö';
                    const finalDestination = (selectedHandling === 'Ë≠≤Ê∏°' || selectedHandling === 'ÈÄÅ„Çä') ? 
                        selectedDestination : '';
                    
                    const success = await updateItemHandlingInAPI(item.id, {
                        handling: finalHandling,
                        destination: finalDestination
                    });
                    
                    if (success) {
                        document.getElementById('handlingModal').remove();
                        alert('‚úÖ Âá¶ÂàÜÊñπÊ≥ï„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
                    }
                });
                
                // „Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥
                document.getElementById('cancelHandlingBtn').addEventListener('click', function() {
                    document.getElementById('handlingModal').remove();
                });
                
                // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
                document.getElementById('handlingModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.remove();
                    }
                });
            }

            async function deleteItemFromAPI(itemId) {
                showLoading('ÂìÅÁõÆ„ÇíÂâäÈô§„Åó„Å¶„ÅÑ„Åæ„Åô...');
                try {
                    if (!gasUrl) {
                        throw new Error('Google Apps Script URL„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    }

                    const formData = new FormData();
                    formData.append('action', 'deleteItem');
                    formData.append('id', itemId);

                    const response = await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'cors',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`ÂâäÈô§„Ç®„É©„Éº: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        await loadItemsFromAPI();
                        hideLoading();
                        return true;
                    } else {
                        throw new Error(result.error || 'ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                } catch (error) {
                    console.error('APIÂâäÈô§„Ç®„É©„Éº:', error);
                    hideLoading();
                    alert('‚ùå ÂìÅÁõÆÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                    return false;
                }
            }

            // Êé•Á∂ö„ÉÜ„Çπ„Éà
            async function testConnection() {
                const url = document.getElementById('gasUrl').value.trim();
                if (!url) {
                    alert('Google Apps Script URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                showLoading('Êé•Á∂ö„ÉÜ„Çπ„Éà‰∏≠...');
                try {
                    const response = await fetch(url + '?action=test', {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        gasUrl = url;
                        localStorage.setItem('gasUrl', url);
                        hideLoading();
                        alert('‚úÖ Êé•Á∂ö„ÉÜ„Çπ„ÉàÊàêÂäüÔºÅGoogle Apps Script„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åó„Åü„ÄÇ');
                        loadItemsFromAPI();
                    } else {
                        throw new Error(`Êé•Á∂ö„Ç®„É©„Éº: ${response.status}`);
                    }
                } catch (error) {
                    hideLoading();
                    alert('‚ùå Êé•Á∂ö„ÉÜ„Çπ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }

            // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
            function showError(message) {
                console.error(message);
                hideLoading();
                alert('„Ç®„É©„Éº: ' + message);
            }

            function showLoading(message) {
                const existingOverlay = document.querySelector('.loading-overlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }

                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.innerHTML = '<div class="loading-spinner"></div><div>' + message + '</div>';
                document.body.appendChild(overlay);
                return overlay;
            }

            function hideLoading() {
                const overlay = document.querySelector('.loading-overlay');
                if (overlay) {
                    overlay.remove();
                }
            }
            
            // „É¶„Éº„Ç∂„ÉºË®≠ÂÆö
            function setUser() {
                try {
                    const userSelect = document.getElementById('userSelect');
                    const username = userSelect.value;
                    
                    if (!username) {
                        alert('ÂÖ•ÂäõËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        return;
                    }
                    
                    currentUser = username;
                    
                    const userDiv = document.getElementById('currentUser');
                    userDiv.innerHTML = 'ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº: <strong>' + username + '</strong> „Åï„Çì';
                    userDiv.classList.remove('hidden');
                    
                    alert('‚úÖ „É¶„Éº„Ç∂„Éº„Åå„Äå' + username + '„Äç„Å´Ë®≠ÂÆö„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
                } catch (error) {
                    showError('„É¶„Éº„Ç∂„ÉºË®≠ÂÆö‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }
            
            // È´òÂúßÁ∏ÆÁîªÂÉèÂá¶ÁêÜÔºà„Çµ„Ç§„Ç∫Â§ßÂπÖÂâäÊ∏õÔºâ
            function processImageForMobile(file) {
                return new Promise((resolve, reject) => {
                    try {
                        const maxFileSize = 2 * 1024 * 1024; // 2MB„Å´Âà∂Èôê
                        const maxResolution = 512; // 512px„Å´Á∏ÆÂ∞èÔºà„Çà„ÇäÂ∞è„Åï„ÅèÔºâ
                        const reader = new FileReader();

                        if (file.size > maxFileSize) {
                            reject(new Error('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„ÅôÔºà2MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ'));
                            return;
                        }

                        if (!file.type.startsWith('image/')) {
                            reject(new Error('ÊúâÂäπ„Å™ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'));
                            return;
                        }

                        reader.onload = function(event) {
                            const img = new Image();
                            img.onload = function() {
                                let width = img.width;
                                let height = img.height;
                                let ratio = width / height;

                                // „Çà„ÇäÁ©çÊ•µÁöÑ„Å´„Çµ„Ç§„Ç∫„ÇíÁ∏ÆÂ∞è
                                if (width > maxResolution || height > maxResolution) {
                                    if (width > height) {
                                        width = maxResolution;
                                        height = width / ratio;
                                    } else {
                                        height = maxResolution;
                                        width = height * ratio;
                                    }
                                }

                                const canvas = document.createElement('canvas');
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                
                                // ÁîªË≥™„ÇíÂêë‰∏ä„Åï„Åõ„Çã„Åü„ÇÅ„ÅÆË®≠ÂÆö
                                ctx.imageSmoothingEnabled = true;
                                ctx.imageSmoothingQuality = 'high';
                                ctx.drawImage(img, 0, 0, width, height);

                                // Â§ßÂπÖ„Å´ÂúßÁ∏ÆÔºàÂìÅË≥™„Çí40%„Å´‰∏ã„Åí„ÇãÔºâ
                                let quality = 0.4;
                                let compressedDataURL = canvas.toDataURL('image/jpeg', quality);
                                
                                // ÊúÄÂ§ß„Éá„Éº„Çø„Çµ„Ç§„Ç∫„Çí150KB„Å´Âà∂Èôê
                                const maxDataSize = 150 * 1024; // 150KB
                                let attempts = 0;
                                
                                while (compressedDataURL.length > maxDataSize && quality > 0.1 && attempts < 5) {
                                    quality -= 0.1;
                                    compressedDataURL = canvas.toDataURL('image/jpeg', quality);
                                    attempts++;
                                }

                                console.log(`ÁîªÂÉèÂúßÁ∏ÆÂÆå‰∫Ü: ${width}x${height}px, ÂìÅË≥™${Math.round(quality*100)}%, „Çµ„Ç§„Ç∫: ${Math.round(compressedDataURL.length/1024)}KB`);
                                resolve(compressedDataURL);
                            };
                            img.src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    } catch (e) {
                        reject(e);
                    }
                });
            }

            // ÂìÅÁõÆ‰∏ÄË¶ß„ÅÆË°®Á§∫
            function displayItems() {
                const itemsList = document.getElementById('itemsList');
                itemsList.innerHTML = '';
                
                if (items.length === 0) {
                    itemsList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                    return;
                }

                items.forEach(item => {
                    const itemCard = document.createElement('div');
                    itemCard.className = `item-card ${item.completed ? 'completed' : ''}`;
                    itemCard.dataset.id = item.id;
                    
                    const itemHeader = document.createElement('div');
                    itemHeader.className = 'item-header';

                    if (item.photoUrl) {
                        const photo = document.createElement('img');
                        photo.src = item.photoUrl;
                        photo.className = 'item-photo';
                        photo.onerror = function() {
                            this.style.display = 'none';
                        };
                        itemHeader.appendChild(photo);
                    }
                    
                    const itemDetails = document.createElement('div');
                    itemDetails.className = 'item-details';
                    
                    // ÂèñÊâ±„ÅÑÊñπÊ≥ï„ÅÆË°®Á§∫„ÇíÊîπÂñÑ
                    const handlingText = item.handling === 'Êú™Ê±∫ÂÆö' ? 
                        '<span style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è Ê±∫ÂÆöÂæÖ„Å°</span>' : 
                        `‚ö° ${item.handling}${item.destination ? ' (' + item.destination + ')' : ''}`;
                    
                    itemDetails.innerHTML = `
                        <h3>${item.name} (${item.count}ÂÄã)</h3>
                        <p style="font-size: 14px; color: #666;">
                            üè∑Ô∏è ${item.category} | ${handlingText}
                        </p>
                        <p style="font-size: 12px; color: #888; margin-top: 5px;">
                            ÁôªÈå≤ËÄÖ: ${item.addedBy}
                        </p>
                    `;
                    itemHeader.appendChild(itemDetails);

                    itemCard.appendChild(itemHeader);
                    
                    if (item.memo) {
                        const memo = document.createElement('p');
                        memo.style.cssText = 'font-size: 14px; margin-top: 10px; padding: 5px; background: #e9ecef; border-radius: 6px;';
                        memo.textContent = `ÂÇôËÄÉ: ${item.memo}`;
                        itemCard.appendChild(memo);
                    }

                    const controls = document.createElement('div');
                    controls.className = 'item-controls';
                    controls.innerHTML = `
                        <button class="btn btn-info btn-toggle-completed">
                            ${item.completed ? '‚úÖ Ê±∫ÂÆöÊ∏à„Åø' : '‚òëÔ∏è Ê±∫ÂÆöÊ∏à„Åø„Å´„Åô„Çã'}
                        </button>
                        <button class="btn btn-primary btn-edit-handling">
                            ‚úèÔ∏è Âá¶ÂàÜÊñπÊ≥ï„ÇíÊ±∫ÂÆö
                        </button>
                        <button class="btn btn-danger btn-delete-item">
                            üóëÔ∏è ÂâäÈô§
                        </button>
                    `;
                    itemCard.appendChild(controls);
                    
                    itemsList.appendChild(itemCard);
                });
            }

            // ÈõÜË®àÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
            function updateSummary() {
                const totalCount = items.length;
                const completedCount = items.filter(item => item.completed).length;
                
                const categoryCounts = items.reduce((acc, item) => {
                    acc[item.category] = (acc[item.category] || 0) + 1;
                    return acc;
                }, {});

                const summaryCards = document.getElementById('summaryGrid').children;
                summaryCards[0].querySelector('h4').textContent = totalCount;
                summaryCards[1].querySelector('h4').textContent = completedCount;
                summaryCards[2].querySelector('h4').textContent = categoryCounts['Âé®ÊàøÂô®ÂÖ∑'] || 0;
                summaryCards[3].querySelector('h4').textContent = categoryCounts['Â∫óÂÜÖÊ©üÊùê'] || 0;
                summaryCards[4].querySelector('h4').textContent = categoryCounts['È£üÂô®È°û'] || 0;
                summaryCards[5].querySelector('h4').textContent = categoryCounts['ÂÇôÂìÅ'] || 0;
            }

            // „Ç´„ÉÜ„Ç¥„É™„ÉªÂèñÊâ±„ÅÑ„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            function resetCategoryButtons() {
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                selectedCategory = '';
                selectedHandling = '';
                document.getElementById('destinationDiv').classList.add('hidden');
                document.getElementById('destination').value = '';
                document.getElementById('photoInput').value = '';
                document.getElementById('photoPreview').classList.add('hidden');
            }

            // CSV„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ©üËÉΩ
            function exportToCSV() {
                if (items.length === 0) {
                    alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                    return;
                }

                const headers = ['ÂìÅÂêç', 'ÂÄãÊï∞', 'Â±ûÊÄß', 'ÂèñÊâ±„ÅÑÊñπÊ≥ï', 'ÈÄÅ„ÇäÂÖà', 'Ê±∫ÂÆöÊ∏à„Åø', 'ÁôªÈå≤ËÄÖ', 'ÁôªÈå≤Êó•ÊôÇ', '„É°„É¢'];
                const csvContent = [
                    headers.join(','),
                    ...items.map(item => [
                        `"${item.name}"`,
                        item.count,
                        `"${item.category}"`,
                        `"${item.handling}"`,
                        `"${item.destination}"`,
                        item.completed ? 'Ê∏à' : 'Êú™',
                        `"${item.addedBy}"`,
                        `"${item.addedAt}"`,
                        `"${item.memo}"`
                    ].join(','))
                ].join('\n');

                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `ÂìÅÁõÆÁÆ°ÁêÜ_${new Date().toISOString().slice(0, 10)}.csv`;
                link.click();
            }

            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
            document.addEventListener('DOMContentLoaded', function() {
                // ‰øùÂ≠ò„Åï„Çå„ÅüURL„ÇíÂæ©ÂÖÉ
                const savedUrl = localStorage.getItem('gasUrl');
                if (savedUrl) {
                    document.getElementById('gasUrl').value = savedUrl;
                    gasUrl = savedUrl;
                    loadItemsFromAPI();
                }

                // Êé•Á∂ö„ÉÜ„Çπ„Éà„Éú„Çø„É≥
                document.getElementById('testConnectionBtn').addEventListener('click', testConnection);

                // „É¶„Éº„Ç∂„ÉºË®≠ÂÆö
                document.getElementById('setUserBtn').addEventListener('click', setUser);

                // „Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû
                document.getElementById('categoryButtons').addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-btn')) {
                        document.querySelectorAll('#categoryButtons .category-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        e.target.classList.add('active');
                        selectedCategory = e.target.dataset.value;
                    }
                });

                // ÂèñÊâ±„ÅÑÊñπÊ≥ïÈÅ∏ÊäûÔºàÈÅ∏ÊäûËß£Èô§Ê©üËÉΩ‰ªò„ÅçÔºâ
                document.getElementById('handlingButtons').addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-btn')) {
                        const clickedValue = e.target.dataset.value;
                        
                        // Âêå„Åò„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà„ÅØÈÅ∏ÊäûËß£Èô§
                        if (selectedHandling === clickedValue) {
                            // ÈÅ∏ÊäûËß£Èô§
                            e.target.classList.remove('active');
                            selectedHandling = '';
                            
                            // ÈÄÅ„ÇäÂÖàÈÅ∏Êäû„Ç®„É™„Ç¢„ÇíÈö†„Åô
                            document.getElementById('destinationDiv').classList.add('hidden');
                            document.getElementById('destination').value = '';
                            
                            // ÈÄÅ„ÇäÂÖà„Éú„Çø„É≥„ÅÆÈÅ∏Êäû„ÇÇËß£Èô§
                            document.querySelectorAll('#destinationButtons .category-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            
                        } else {
                            // ‰ªñ„ÅÆ„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢
                            document.querySelectorAll('#handlingButtons .category-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            
                            // Êñ∞„Åó„ÅÑ„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´
                            e.target.classList.add('active');
                            selectedHandling = clickedValue;
                            
                            // ÈÄÅ„ÇäÂÖà„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØË°®Á§∫
                            const destinationDiv = document.getElementById('destinationDiv');
                            if (selectedHandling === 'Ë≠≤Ê∏°' || selectedHandling === 'ÈÄÅ„Çä') {
                                destinationDiv.classList.remove('hidden');
                            } else {
                                destinationDiv.classList.add('hidden');
                                document.getElementById('destination').value = '';
                                // ÈÄÅ„ÇäÂÖà„Éú„Çø„É≥„ÅÆÈÅ∏Êäû„ÇÇËß£Èô§
                                document.querySelectorAll('#destinationButtons .category-btn').forEach(btn => {
                                    btn.classList.remove('active');
                                });
                            }
                        }
                    }
                });

                // ÈÄÅ„ÇäÂÖàÈÅ∏ÊäûÔºàÈÅ∏ÊäûËß£Èô§Ê©üËÉΩ‰ªò„ÅçÔºâ
                document.getElementById('destinationButtons').addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-btn')) {
                        const clickedValue = e.target.dataset.value;
                        const destinationInput = document.getElementById('destination');
                        
                        // ÁèæÂú®ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Éú„Çø„É≥„ÇíÁ¢∫Ë™ç
                        const currentlySelected = document.querySelector('#destinationButtons .category-btn.active');
                        const currentValue = currentlySelected ? currentlySelected.dataset.value : null;
                        
                        // Âêå„Åò„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà„ÅØÈÅ∏ÊäûËß£Èô§
                        if (currentValue === clickedValue) {
                            // ÈÅ∏ÊäûËß£Èô§
                            e.target.classList.remove('active');
                            destinationInput.style.display = 'none';
                            destinationInput.value = '';
                        } else {
                            // ‰ªñ„ÅÆ„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢
                            document.querySelectorAll('#destinationButtons .category-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            
                            // Êñ∞„Åó„ÅÑ„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´
                            e.target.classList.add('active');
                            
                            if (clickedValue === '„Åù„ÅÆ‰ªñ') {
                                destinationInput.style.display = 'block';
                                destinationInput.value = '';
                                destinationInput.focus();
                            } else {
                                destinationInput.style.display = 'none';
                                destinationInput.value = clickedValue;
                            }
                        }
                    }
                });

                // ÂÜôÁúü„Éó„É¨„Éì„É•„ÉºÔºàÂúßÁ∏ÆÊÉÖÂ†±Ë°®Á§∫Âº∑ÂåñÔºâ
                document.getElementById('photoInput').addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const preview = document.getElementById('photoPreview');
                        const previewImage = document.getElementById('previewImage');
                        const compressionInfo = document.getElementById('compressionInfo');
                        
                        // ÂÖÉ„ÅÆ„Éï„Ç°„Ç§„É´ÊÉÖÂ†±„ÇíË°®Á§∫
                        const originalSizeKB = Math.round(file.size / 1024);
                        compressionInfo.innerHTML = `<span style="color: #666;">Âá¶ÁêÜ‰∏≠... ÂÖÉ„Éï„Ç°„Ç§„É´: ${originalSizeKB}KB</span>`;
                        preview.classList.remove('hidden');
                        
                        try {
                            // ÁîªÂÉè„ÇíÂúßÁ∏ÆÂá¶ÁêÜ
                            const compressedDataURL = await processImageForMobile(file);
                            previewImage.src = compressedDataURL;
                            
                            // ÂúßÁ∏ÆÂæå„ÅÆ„Çµ„Ç§„Ç∫„ÇíË®àÁÆó
                            const compressedSizeKB = Math.round(compressedDataURL.length / 1024);
                            const compressionRatio = Math.round((1 - compressedSizeKB / originalSizeKB) * 100);
                            
                            compressionInfo.innerHTML = `
                                <span style="color: #28a745; font-weight: bold;">‚úÖ ÂúßÁ∏ÆÂÆå‰∫Ü</span><br>
                                <small>ÂÖÉ„Éï„Ç°„Ç§„É´: ${originalSizeKB}KB ‚Üí ÂúßÁ∏ÆÂæå: ${compressedSizeKB}KB (${compressionRatio}% ÂâäÊ∏õ)</small>
                            `;
                        } catch (error) {
                            compressionInfo.innerHTML = `<span style="color: #dc3545;">‚ùå ÂúßÁ∏Æ„Ç®„É©„Éº: ${error.message}</span>`;
                        }
                    }
                });

                // ÂìÅÁõÆËøΩÂä†„Éú„Çø„É≥
                document.getElementById('addItemBtn').addEventListener('click', async function() {
                    if (!currentUser) {
                        alert('„Åæ„Åö„ÄÅÂÖ•ÂäõËÄÖÂêç„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        return;
                    }

                    if (!gasUrl) {
                        alert('Google Apps Script URL„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        return;
                    }

                    const itemName = document.getElementById('itemName').value.trim();
                    const itemCount = parseInt(document.getElementById('itemCount').value);
                    const itemMemo = document.getElementById('itemMemo').value.trim();

                    if (!itemName) {
                        alert('ÂìÅÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        return;
                    }

                    // ÂèñÊâ±„ÅÑÊñπÊ≥ï„Å®Â±ûÊÄß„ÅØÂøÖÈ†à„Åß„ÅØ„Å™„ÅÑÔºàÊú™ÈÅ∏Êäû„Åß„ÇÇOKÔºâ
                    const finalCategory = selectedCategory || 'Êú™ÂàÜÈ°û';
                    const finalHandling = selectedHandling || 'Êú™Ê±∫ÂÆö';
                    
                    const destinationInput = document.getElementById('destination');
                    const finalDestination = (selectedHandling === 'Ë≠≤Ê∏°' || selectedHandling === 'ÈÄÅ„Çä') ? 
                        (destinationInput.value || destinationInput.placeholder) : '';
                    
                    let photoDataUrl = null;
                    const photoInput = document.getElementById('photoInput');
                    if (photoInput.files.length > 0) {
                        try {
                            photoDataUrl = await processImageForMobile(photoInput.files[0]);
                        } catch (error) {
                            alert(error.message);
                            return;
                        }
                    }

                    const newItem = {
                        name: itemName,
                        count: itemCount,
                        category: finalCategory,
                        handling: finalHandling,
                        destination: finalDestination,
                        addedBy: currentUser,
                        memo: itemMemo,
                        photoDataUrl: photoDataUrl
                    };

                    await addItemToAPI(newItem);
                    
                    // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
                    document.getElementById('itemName').value = '';
                    document.getElementById('itemCount').value = '1';
                    document.getElementById('itemMemo').value = '';
                    resetCategoryButtons();
                });

                // „É™„Éï„É¨„ÉÉ„Ç∑„É•„Éú„Çø„É≥
                document.getElementById('refreshBtn').addEventListener('click', loadItemsFromAPI);

                // Google Sheets„ÅßÁ¢∫Ë™ç„Éú„Çø„É≥
                document.getElementById('openSheetsBtn').addEventListener('click', function() {
                    // Áõ¥Êé•„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÅÆURL„ÇíÈñã„Åè
                    const spreadsheetUrl = 'https://docs.google.com/spreadsheets/d/1vB-ymJZ2OSccz-3S5peH75B1ccriXDMfqJLrLXdX3JQ/edit';
                    window.open(spreadsheetUrl, '_blank');
                });

                // CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éú„Çø„É≥
                document.getElementById('exportBtn').addEventListener('click', exportToCSV);

                // „Ç¢„Ç§„ÉÜ„É†„É™„Çπ„Éà„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÔºàÊ±∫ÂÆöÊ∏à„ÅøÂàá„ÇäÊõø„Åà„ÄÅÂá¶ÂàÜÊñπÊ≥ïÊ±∫ÂÆö„ÄÅÂâäÈô§Ôºâ
                document.addEventListener('click', async function(e) {
                    if (e.target.classList.contains('btn-toggle-completed')) {
                        const itemCard = e.target.closest('.item-card');
                        const itemId = itemCard.dataset.id;
                        const item = items.find(item => item.id === itemId);
                        
                        if (item && gasUrl) {
                            const newCompletedStatus = !item.completed;
                            const success = await updateItemInAPI(itemId, { 
                                completed: newCompletedStatus 
                            });
                            
                            if (success) {
                                // „É≠„Éº„Ç´„É´„ÅÆÁä∂ÊÖã„ÇÇÊõ¥Êñ∞
                                item.completed = newCompletedStatus;
                                displayItems();
                                updateSummary();
                            }
                        }
                    }
                    
                    if (e.target.classList.contains('btn-edit-handling')) {
                        const itemCard = e.target.closest('.item-card');
                        const itemId = itemCard.dataset.id;
                        const item = items.find(item => item.id === itemId);
                        
                        if (item) {
                            showHandlingModal(item);
                        }
                    }
                    
                    if (e.target.classList.contains('btn-delete-item')) {
                        const itemCard = e.target.closest('.item-card');
                        const itemId = itemCard.dataset.id;
                        const item = items.find(item => item.id === itemId);
                        
                        if (item && gasUrl) {
                            // Á¢∫Ë™ç„Å™„Åó„ÅßÂç≥Â∫ß„Å´ÂâäÈô§
                            const success = await deleteItemFromAPI(itemId);
                            if (success) {
                                // „É≠„Éº„Ç´„É´„Åã„Çâ„ÇÇÂâäÈô§
                                const index = items.findIndex(item => item.id === itemId);
                                if (index > -1) {
                                    items.splice(index, 1);
                                }
                                displayItems();
                                updateSummary();
                            }
                        }
                    }
                });
            });

        })();
    </script>
</body>
</html>
