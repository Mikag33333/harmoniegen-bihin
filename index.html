<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç¢„É´„É¢„Éã„ÉºÁéÑ Ê©üÊùê„ÉªÂÇôÂìÅÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        /* CSS„ÅØÂ§âÊõ¥„Å™„Åó */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .database-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .database-status.connected {
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid #28a745;
            color: #155724;
        }

        .database-status.disconnected {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid #dc3545;
            color: #721c24;
        }

        .database-status.connecting {
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid #ffc107;
            color: #856404;
        }

        .gas-url-section {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .gas-url-section h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .main-content {
            padding: 20px;
        }
        
        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #20c997);
            color: white;
        }
        
        .btn:hover, .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .category-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin: 10px 0;
        }
        
        .category-btn {
            padding: 12px 8px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
            touch-action: manipulation;
            font-size: 14px;
        }
        
        .category-btn:hover, .category-btn:active {
            background: #f8f9fa;
        }
        
        .category-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }
        
        .item-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            position: relative;
        }
        
        .item-card.completed {
            border-color: #28a745;
            background: #f8fff9;
        }

        .item-card.syncing {
            border-color: #ffc107;
            background: #fff8e1;
        }

        .item-card.syncing::after {
            content: "üîÑ ÂêåÊúü‰∏≠...";
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffc107;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .item-card:hover, .item-card:active {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .item-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            flex-direction: column;
        }
        
        @media (min-width: 500px) {
            .item-header {
                flex-direction: row;
                align-items: center;
            }
        }
        
        .item-photo {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #ddd;
            margin-bottom: 10px;
        }
        
        @media (min-width: 500px) {
            .item-photo {
                width: 100px;
                height: 100px;
                margin-right: 15px;
                margin-bottom: 0;
            }
        }
        
        .item-details {
            flex: 1;
        }
        
        .item-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .summary-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .summary-card {
            background: rgba(255,255,255,0.1);
            padding: 15px 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-card h4 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        
        .summary-card p {
            font-size: 0.9em;
        }
        
        .user-info {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .hidden {
            display: none !important;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
            flex-direction: column;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .section {
                padding: 15px;
            }
            
            .category-buttons {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 6px;
            }
            
            .category-btn {
                padding: 10px 6px;
                font-size: 13px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è „Ç¢„É´„É¢„Éã„ÉºÁéÑ</h1>
            <p>Ê©üÊùê„ÉªÂÇôÂìÅÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†ÔºàGoogle SheetsÁâàÔºâ</p>
        </div>
        
        <div class="main-content">
            <!-- Google Apps Script URLË®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="gas-url-section">
                <h4>‚öôÔ∏è Google Apps Script URLË®≠ÂÆö</h4>
                <div class="form-group">
                    <label>Google Apps Script „Ç¶„Çß„Éñ„Ç¢„Éó„É™URL</label>
                    <input type="url" id="gasUrl" placeholder="https://script.google.com/macros/s/.../exec" 
                           value="https://script.google.com/macros/s/AKfycbyS16NIjTSXfXQnl6AgU-TfqjUuyCJQvj3ubeTTro_VJWG_kMb_rfMxhqljqH0hg0fA/exec">
                    <small style="color: #666; font-size: 12px;">
                        Google Apps Script„Åß‰ΩúÊàê„Åó„Åü„Ç¶„Çß„Éñ„Ç¢„Éó„É™„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                    </small>
                </div>
                <button class="btn btn-primary" id="testConnectionBtn">Êé•Á∂ö„ÉÜ„Çπ„Éà</button>
            </div>

            <div id="databaseStatus" class="database-status connecting">
                üü° „Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...
            </div>
            
            <div class="section">
                <h3>üë§ ÂÖ•ÂäõËÄÖË®≠ÂÆö</h3>
                <div class="form-group">
                    <label>ÂÖ•ÂäõËÄÖÂêç„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</label>
                    <select id="userSelect">
                        <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        <option value="‰∏â„É∂Â∞ª">‰∏â„É∂Â∞ª</option>
                        <option value="Ê°Ç">Ê°Ç</option>
                        <option value="ÈòøÊØîÁïô">ÈòøÊØîÁïô</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="setUserBtn">Ë®≠ÂÆö</button>
                <div id="currentUser" class="user-info hidden"></div>
            </div>
            
            <div class="section">
                <h3>üìù Êñ∞„Åó„ÅÑÂìÅÁõÆ„ÇíËøΩÂä†</h3>
                
                <div class="form-group">
                    <label>üì∑ ÂÜôÁúü„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ <span style="color: #6c757d; font-size: 14px;">(„Ç™„Éó„Ç∑„Éß„É≥)</span></label>
                    <input type="file" id="photoInput" accept="image/*" capture="environment">
                    <div id="photoPreview" class="hidden" style="margin-top: 10px;">
                        <img id="previewImage" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid #ddd;">
                        <p id="compressionInfo" style="font-size: 12px; color: #6c757d; margin-top: 5px;"></p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>üìã ÂìÅÂêç</label>
                    <input type="text" id="itemName" placeholder="ÂìÅÁõÆÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
                </div>
                
                <div class="form-group">
                    <label>üî¢ ÂÄãÊï∞</label>
                    <input type="number" id="itemCount" value="1" min="1">
                </div>

                <div class="form-group">
                    <label>üìù „É°„É¢„ÉªÂÇôËÄÉ</label>
                    <input type="text" id="itemMemo" placeholder="„Çµ„Ç§„Ç∫„ÄÅÁä∂ÊÖã„ÄÅÁâπË®ò‰∫ãÈ†Ö„Å™„Å©Ôºà‰ªªÊÑèÔºâ">
                </div>
                
                <div class="form-group">
                    <label>üè∑Ô∏è Â±ûÊÄß„ÇíÈÅ∏Êäû</label>
                    <div class="category-buttons" id="categoryButtons">
                        <button class="category-btn" data-value="Âé®ÊàøÂô®ÂÖ∑">Âé®ÊàøÂô®ÂÖ∑</button>
                        <button class="category-btn" data-value="Â∫óÂÜÖÊ©üÊùê">Â∫óÂÜÖÊ©üÊùê</button>
                        <button class="category-btn" data-value="È£üÂô®È°û">È£üÂô®È°û</button>
                        <button class="category-btn" data-value="ÂÇôÂìÅ">ÂÇôÂìÅ</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>‚ö° ÂèñÊâ±„ÅÑÊñπÊ≥ï</label>
                    <div class="category-buttons" id="handlingButtons">
                        <button class="category-btn" data-value="Âá¶ÂàÜ">Âá¶ÂàÜ</button>
                        <button class="category-btn" data-value="Ë≠≤Ê∏°">Ë≠≤Ê∏°</button>
                        <button class="category-btn" data-value="ÈÄÅ„Çä">ÈÄÅ„Çä</button>
                    </div>
                    <div id="destinationDiv" class="form-group hidden">
                        <label>Ë≠≤Ê∏°ÂÖà/ÈÄÅ„ÇäÂÖà</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px;" id="destinationButtons">
                            <button type="button" class="category-btn" data-value="ÂØæÈ¶¨">ÂØæÈ¶¨</button>
                            <button type="button" class="category-btn" data-value="Ë•øÊñ∞">Ë•øÊñ∞</button>
                            <button type="button" class="category-btn" data-value="Á§æÈï∑Ëá™ÂÆÖ">Á§æÈï∑Ëá™ÂÆÖ</button>
                            <button type="button" class="category-btn" data-value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</button>
                        </div>
                        <input type="text" id="destination" placeholder="„Åù„ÅÆ‰ªñ„ÅÆÂ†¥Âêà„ÅØÁõ¥Êé•ÂÖ•Âäõ" style="display: none;">
                    </div>
                </div>
                
                <button class="btn btn-success" id="addItemBtn">ÂìÅÁõÆ„ÇíËøΩÂä†</button>
                <p id="addItemStatus" style="font-size: 14px; color: #666; margin-top: 5px;">
                    ‚úÖ Êé•Á∂öÊ∏à„Åø
                </p>
            </div>
            
            <div class="section">
                <h3>üì¶ ÁôªÈå≤Ê∏à„ÅøÂìÅÁõÆ‰∏ÄË¶ß</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="btn btn-info" id="refreshBtn">üîÑ ÊúÄÊñ∞„Éá„Éº„Çø„ÇíÂèñÂæó</button>
                    <button class="btn btn-primary" id="openSheetsBtn">üìä Google Sheets„ÅßÁ¢∫Ë™ç</button>
                </div>
                <div id="itemsList">
                    <p style="text-align: center; color: #6c757d; padding: 40px;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                </div>
            </div>
            
            <div class="summary-section">
                <h3>üìä ÈõÜË®àÊÉÖÂ†±</h3>
                <div class="summary-grid" id="summaryGrid">
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>Á∑èÂìÅÁõÆÊï∞</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>Ê±∫ÂÆöÊ∏à„Åø</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>Âé®ÊàøÂô®ÂÖ∑</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>Â∫óÂÜÖÊ©üÊùê</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>È£üÂô®È°û</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>ÂÇôÂìÅ</p>
                    </div>
                </div>
                <button class="btn btn-success" id="exportBtn">üìÑ CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
            </div>
        </div>
    </div>
    
    <script>
        (function() {
            'use strict';
            
            let currentUser = '';
            let items = [];
            let selectedCategory = '';
            let selectedHandling = '';
            let gasUrl = '';
            
            // Êé•Á∂öÁä∂ÊÖã„ÅÆÊõ¥Êñ∞
            function updateConnectionStatus(status) {
                const statusDiv = document.getElementById('databaseStatus');
                statusDiv.className = 'database-status ' + status;
                
                switch(status) {
                    case 'connected':
                        statusDiv.innerHTML = 'üü¢ Google SheetsÊé•Á∂öÊ∏à„Åø - „Éá„Éº„ÇøÂêåÊúüÂèØËÉΩ';
                        break;
                    case 'connecting':
                        statusDiv.innerHTML = 'üü° „Éá„Éº„ÇøÂêåÊúü‰∏≠...';
                        break;
                    case 'disconnected':
                        statusDiv.innerHTML = 'üî¥ Êé•Á∂ö„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                        break;
                }
            }
            
            // Google Apps Script„Åã„Çâ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
            async function loadItemsFromAPI() {
                updateConnectionStatus('connecting');
                try {
                    if (!gasUrl) {
                        throw new Error('Google Apps Script URL„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    }

                    const response = await fetch(gasUrl + '?action=getItems', {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Google Apps Script„Åã„Çâ„ÅÆ„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Google Apps Script„Åã„Çâ„ÅÆÈÖçÂàó„Éá„Éº„Çø„ÇíÂá¶ÁêÜ
                    if (Array.isArray(data)) {
                        items = data.map((item, index) => ({
                            id: item.id || item['ID'] || `item_${index}`,
                            name: item.name || item['ÂìÅÂêç'] || '',
                            count: parseInt(item.count || item['ÂÄãÊï∞']) || 1,
                            category: item.category || item['Â±ûÊÄß'] || 'ÂÇôÂìÅ',
                            handling: item.handling || item['ÂèñÊâ±„ÅÑÊñπÊ≥ï'] || 'Êú™Ê±∫ÂÆö',
                            destination: item.destination || item['ÈÄÅ„ÇäÂÖà'] || '',
                            completed: item.completed === true || item.completed === 'true' || item['Ê±∫ÂÆöÊ∏à„Åø'] === true || item['Ê±∫ÂÆöÊ∏à„Åø'] === 'true',
                            addedBy: item.addedBy || item['ÁôªÈå≤ËÄÖ'] || '',
                            addedAt: item.addedAt || item['ÁôªÈå≤Êó•ÊôÇ'] || '',
                            memo: item.memo || item['„É°„É¢'] || '',
                            photoUrl: item.photoUrl || item['ÂÜôÁúüURL'] || null
                        }));
                    } else {
                        items = [];
                    }

                    displayItems();
                    updateSummary();
                    updateConnectionStatus('connected');
                    console.log('Google Apps Script„Åã„Çâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü:', items.length, '‰ª∂');
                } catch (error) {
                    console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    updateConnectionStatus('disconnected');
                    alert('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }
            
            // Google Apps Script„Å´ÂìÅÁõÆËøΩÂä†
            async function addItemToAPI(item) {
                showLoading('ÂìÅÁõÆ„ÇíËøΩÂä†„Åó„Å¶„ÅÑ„Åæ„Åô...');
                try {
                    if (!gasUrl) {
                        throw new Error('Google Apps Script URL„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    }

                    const formData = new FormData();
                    formData.append('action', 'addItem');
                    formData.append('name', item.name);
                    formData.append('count', item.count);
                    formData.append('category', item.category);
                    formData.append('handling', item.handling);
                    formData.append('destination', item.destination);
                    formData.append('addedBy', item.addedBy);
                    formData.append('memo', item.memo);
                    formData.append('photoDataUrl', item.photoDataUrl || '');

                    const response = await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'cors',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`ËøΩÂä†„Ç®„É©„Éº: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    if (result.success) {
                        await loadItemsFromAPI();
                        hideLoading();
                        alert('‚úÖ ÂìÅÁõÆ„ÅåËøΩÂä†„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
                    } else {
                        throw new Error(result.error || '‰∏çÊòé„Å™„Ç®„É©„Éº');
                    }
                    
                } catch (error) {
                    console.error('APIËøΩÂä†„Ç®„É©„Éº:', error);
                    hideLoading();
                    alert('‚ùå ÂìÅÁõÆËøΩÂä†‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }
            
            // Google Apps Script„ÅßÂìÅÁõÆÊõ¥Êñ∞
            async function updateItemInAPI(itemId, updates) {
                showLoading('ÂìÅÁõÆ„ÇíÊõ¥Êñ∞„Åó„Å¶„ÅÑ„Åæ„Åô...');
                try {
                    if (!gasUrl) {
                        throw new Error('Google Apps Script URL„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    }

                    const formData = new FormData();
                    formData.append('action', 'updateItem');
                    formData.append('id', itemId);
                    Object.keys(updates).forEach(key => {
                        formData.append(key, updates[key]);
                    });

                    const response = await fetch(gasUrl, {
                        method: 'POST',
                        mode: 'cors',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Êõ¥Êñ∞„Ç®„É©„Éº: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        await loadItemsFromAPI();
                        hideLoading();
                        return true;
                    } else {
                        throw new Error(result.error || 'Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                } catch (error) {
                    console.error('APIÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                    hideLoading();
                    alert('‚ùå ÂìÅÁõÆÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                    return false;
                }
            }

            // Êé•Á∂ö„ÉÜ„Çπ„Éà
            async function testConnection() {
                const url = document.getElementById('gasUrl').value.trim();
                if (!url) {
                    alert('Google Apps Script URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                showLoading('Êé•Á∂ö„ÉÜ„Çπ„Éà‰∏≠...');
                try {
                    const response = await fetch(url + '?action=test', {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        gasUrl = url;
                        localStorage.setItem('gasUrl', url);
                        hideLoading();
                        alert('‚úÖ Êé•Á∂ö„ÉÜ„Çπ„ÉàÊàêÂäüÔºÅGoogle Apps Script„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åó„Åü„ÄÇ');
                        loadItemsFromAPI();
                    } else {
                        throw new Error(`Êé•Á∂ö„Ç®„É©„Éº: ${response.status}`);
                    }
                } catch (error) {
                    hideLoading();
                    alert('‚ùå Êé•Á∂ö„ÉÜ„Çπ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }

            // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
            function showError(message) {
                console.error(message);
                hideLoading();
                alert('„Ç®„É©„Éº: ' + message);
            }

            function showLoading(message) {
                const existingOverlay = document.querySelector('.loading-overlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }

                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.innerHTML = '<div class="loading-spinner"></div><div>' + message + '</div>';
                document.body.appendChild(overlay);
                return overlay;
            }

            function hideLoading() {
                const overlay = document.querySelector('.loading-overlay');
                if (overlay) {
                    overlay.remove();
                }
            }
            
            // „É¶„Éº„Ç∂„ÉºË®≠ÂÆö
            function setUser() {
                try {
                    const userSelect = document.getElementById('userSelect');
                    const username = userSelect.value;
                    
                    if (!username) {
                        alert('ÂÖ•ÂäõËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        return;
                    }
                    
                    currentUser = username;
                    
                    const userDiv = document.getElementById('currentUser');
                    userDiv.innerHTML = 'ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº: <strong>' + username + '</strong> „Åï„Çì';
                    userDiv.classList.remove('hidden');
                    
                    alert('‚úÖ „É¶„Éº„Ç∂„Éº„Åå„Äå' + username + '„Äç„Å´Ë®≠ÂÆö„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
                } catch (error) {
                    showError('„É¶„Éº„Ç∂„ÉºË®≠ÂÆö‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }
            
            // ËªΩÈáèÁîªÂÉèÂá¶ÁêÜÔºà„É¢„Éê„Ç§„É´ÂØæÂøúÔºâ
            function processImageForMobile(file) {
                return new Promise((resolve, reject) => {
                    try {
                        const maxFileSize = 5 * 1024 * 1024; // 5MB
                        const maxResolution = 1024; // 1024px
                        const reader = new FileReader();

                        if (file.size > maxFileSize) {
                            reject(new Error('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„ÅôÔºà5MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ'));
                            return;
                        }

                        if (!file.type.startsWith('image/')) {
                            reject(new Error('ÊúâÂäπ„Å™ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'));
                            return;
                        }

                        reader.onload = function(event) {
                            const img = new Image();
                            img.onload = function() {
                                let width = img.width;
                                let height = img.height;
                                let ratio = width / height;

                                if (width > maxResolution || height > maxResolution) {
                                    if (width > height) {
                                        width = maxResolution;
                                        height = width / ratio;
                                    } else {
                                        height = maxResolution;
                                        width = height * ratio;
                                    }
                                }

                                const canvas = document.createElement('canvas');
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);

                                const resizedDataURL = canvas.toDataURL('image/jpeg', 0.8); // 80%ÂìÅË≥™
                                resolve(resizedDataURL);
                            };
                            img.src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    } catch (e) {
                        reject(e);
                    }
                });
            }

            // ÂìÅÁõÆ‰∏ÄË¶ß„ÅÆË°®Á§∫
            function displayItems() {
                const itemsList = document.getElementById('itemsList');
                itemsList.innerHTML = '';
                
                if (items.length === 0) {
                    itemsList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                    return;
                }

                items.forEach(item => {
                    const itemCard = document.createElement('div');
                    itemCard.className = `item-card ${item.completed ? 'completed' : ''}`;
                    itemCard.dataset.id = item.id;
                    
                    const itemHeader = document.createElement('div');
                    itemHeader.className = 'item-header';

                    if (item.photoUrl) {
                        const photo = document.createElement('img');
                        photo.src = item.photoUrl;
                        photo.className = 'item-photo';
                        photo.onerror = function() {
                            this.style.display = 'none';
                        };
                        itemHeader.appendChild(photo);
                    }
                    
                    const itemDetails = document.createElement('div');
                    itemDetails.className = 'item-details';
                    itemDetails.innerHTML = `
                        <h3>${item.name} (${item.count}ÂÄã)</h3>
                        <p style="font-size: 14px; color: #666;">
                            üè∑Ô∏è ${item.category} | ‚ö° ${item.handling}${item.destination ? ' (' + item.destination + ')' : ''}
                        </p>
                        <p style="font-size: 12px; color: #888; margin-top: 5px;">
                            ÁôªÈå≤ËÄÖ: ${item.addedBy}
                        </p>
                    `;
                    itemHeader.appendChild(itemDetails);

                    itemCard.appendChild(itemHeader);
                    
                    if (item.memo) {
                        const memo = document.createElement('p');
                        memo.style.cssText = 'font-size: 14px; margin-top: 10px; padding: 5px; background: #e9ecef; border-radius: 6px;';
                        memo.textContent = `ÂÇôËÄÉ: ${item.memo}`;
                        itemCard.appendChild(memo);
                    }

                    const controls = document.createElement('div');
                    controls.className = 'item-controls';
                    controls.innerHTML = `
                        <button class="btn btn-info btn-toggle-completed">
                            ${item.completed ? '‚úÖ Ê±∫ÂÆöÊ∏à„Åø' : '‚òëÔ∏è Ê±∫ÂÆöÊ∏à„Åø„Å´„Åô„Çã'}
                        </button>
                    `;
                    itemCard.appendChild(controls);
                    
                    itemsList.appendChild(itemCard);
                });
            }

            // ÈõÜË®àÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
            function updateSummary() {
                const totalCount = items.length;
                const completedCount = items.filter(item => item.completed).length;
                
                const categoryCounts = items.reduce((acc, item) => {
                    acc[item.category] = (acc[item.category] || 0) + 1;
                    return acc;
                }, {});

                const summaryCards = document.getElementById('summaryGrid').children;
                summaryCards[0].querySelector('h4').textContent = totalCount;
                summaryCards[1].querySelector('h4').textContent = completedCount;
                summaryCards[2].querySelector('h4').textContent = categoryCounts['Âé®ÊàøÂô®ÂÖ∑'] || 0;
                summaryCards[3].querySelector('h4').textContent = categoryCounts['Â∫óÂÜÖÊ©üÊùê'] || 0;
                summaryCards[4].querySelector('h4').textContent = categoryCounts['È£üÂô®È°û'] || 0;
                summaryCards[5].querySelector('h4').textContent = categoryCounts['ÂÇôÂìÅ'] || 0;
            }

            // „Ç´„ÉÜ„Ç¥„É™„ÉªÂèñÊâ±„ÅÑ„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            function resetCategoryButtons() {
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                selectedCategory = '';
                selectedHandling = '';
                document.getElementById('destinationDiv').classList.add('hidden');
                document.getElementById('destination').value = '';
                document.getElementById('photoInput').value = '';
                document.getElementById('photoPreview').classList.add('hidden');
            }

            // CSV„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ©üËÉΩ
            function exportToCSV() {
                if (items.length === 0) {
                    alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                    return;
                }

                const headers = ['ÂìÅÂêç', 'ÂÄãÊï∞', 'Â±ûÊÄß', 'ÂèñÊâ±„ÅÑÊñπÊ≥ï', 'ÈÄÅ„ÇäÂÖà', 'Ê±∫ÂÆöÊ∏à„Åø', 'ÁôªÈå≤ËÄÖ', 'ÁôªÈå≤Êó•ÊôÇ', '„É°„É¢'];
                const csvContent = [
                    headers.join(','),
                    ...items.map(item => [
                        `"${item.name}"`,
                        item.count,
                        `"${item.category}"`,
                        `"${item.handling}"`,
                        `"${item.destination}"`,
                        item.completed ? 'Ê∏à' : 'Êú™',
                        `"${item.addedBy}"`,
                        `"${item.addedAt}"`,
                        `"${item.memo}"`
                    ].join(','))
                ].join('\n');

                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `ÂìÅÁõÆÁÆ°ÁêÜ_${new Date().toISOString().slice(0, 10)}.csv`;
                link.click();
            }

            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
            document.addEventListener('DOMContentLoaded', function() {
                // ‰øùÂ≠ò„Åï„Çå„ÅüURL„ÇíÂæ©ÂÖÉ
                const savedUrl = localStorage.getItem('gasUrl');
                if (savedUrl) {
                    document.getElementById('gasUrl').value = savedUrl;
                    gasUrl = savedUrl;
                    loadItemsFromAPI();
                }

                // Êé•Á∂ö„ÉÜ„Çπ„Éà„Éú„Çø„É≥
                document.getElementById('testConnectionBtn').addEventListener('click', testConnection);

                // „É¶„Éº„Ç∂„ÉºË®≠ÂÆö
                document.getElementById('setUserBtn').addEventListener('click', setUser);

                // „Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû
                document.getElementById('categoryButtons').addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-btn')) {
                        document.querySelectorAll('#categoryButtons .category-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        e.target.classList.add('active');
                        selectedCategory = e.target.dataset.value;
                    }
                });

                // ÂèñÊâ±„ÅÑÊñπÊ≥ïÈÅ∏Êäû
                document.getElementById('handlingButtons').addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-btn')) {
                        document.querySelectorAll('#handlingButtons .category-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        e.target.classList.add('active');
                        selectedHandling = e.target.dataset.value;
                        
                        const destinationDiv = document.getElementById('destinationDiv');
                        if (selectedHandling === 'Ë≠≤Ê∏°' || selectedHandling === 'ÈÄÅ„Çä') {
                            destinationDiv.classList.remove('hidden');
                        } else {
                            destinationDiv.classList.add('hidden');
                        }
                    }
                });

                // ÈÄÅ„ÇäÂÖàÈÅ∏Êäû
                document.getElementById('destinationButtons').addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-btn')) {
                        document.querySelectorAll('#destinationButtons .category-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        e.target.classList.add('active');
                        
                        const destinationInput = document.getElementById('destination');
                        if (e.target.dataset.value === '„Åù„ÅÆ‰ªñ') {
                            destinationInput.style.display = 'block';
                            destinationInput.focus();
                        } else {
                            destinationInput.style.display = 'none';
                            destinationInput.value = e.target.dataset.value;
                        }
                    }
                });

                // ÂÜôÁúü„Éó„É¨„Éì„É•„Éº
                document.getElementById('photoInput').addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const preview = document.getElementById('photoPreview');
                            const previewImage = document.getElementById('previewImage');
                            const compressionInfo = document.getElementById('compressionInfo');
                            
                            previewImage.src = event.target.result;
                            compressionInfo.textContent = `„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫: ${(file.size / 1024).toFixed(1)}KB`;
                            preview.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // ÂìÅÁõÆËøΩÂä†„Éú„Çø„É≥
                document.getElementById('addItemBtn').addEventListener('click', async function() {
                    if (!currentUser) {
                        alert('„Åæ„Åö„ÄÅÂÖ•ÂäõËÄÖÂêç„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        return;
                    }

                    if (!gasUrl) {
                        alert('Google Apps Script URL„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        return;
                    }

                    const itemName = document.getElementById('itemName').value.trim();
                    const itemCount = parseInt(document.getElementById('itemCount').value);
                    const itemMemo = document.getElementById('itemMemo').value.trim();

                    if (!itemName) {
                        alert('ÂìÅÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        return;
                    }

                    if (!selectedCategory) {
                        alert('Â±ûÊÄß„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        return;
                    }

                    if (!selectedHandling) {
                        alert('ÂèñÊâ±„ÅÑÊñπÊ≥ï„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        return;
                    }
                    
                    const destinationInput = document.getElementById('destination');
                    const finalDestination = (selectedHandling === 'Ë≠≤Ê∏°' || selectedHandling === 'ÈÄÅ„Çä') ? 
                        (destinationInput.value || destinationInput.placeholder) : '';
                    
                    let photoDataUrl = null;
                    const photoInput = document.getElementById('photoInput');
                    if (photoInput.files.length > 0) {
                        try {
                            photoDataUrl = await processImageForMobile(photoInput.files[0]);
                        } catch (error) {
                            alert(error.message);
                            return;
                        }
                    }

                    const newItem = {
                        name: itemName,
                        count: itemCount,
                        category: selectedCategory,
                        handling: selectedHandling,
                        destination: finalDestination,
                        addedBy: currentUser,
                        memo: itemMemo,
                        photoDataUrl: photoDataUrl
                    };

                    await addItemToAPI(newItem);
                    
                    // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
                    document.getElementById('itemName').value = '';
                    document.getElementById('itemCount').value = '1';
                    document.getElementById('itemMemo').value = '';
                    resetCategoryButtons();
                });

                // „É™„Éï„É¨„ÉÉ„Ç∑„É•„Éú„Çø„É≥
                document.getElementById('refreshBtn').addEventListener('click', loadItemsFromAPI);

                // Google Sheets„ÅßÁ¢∫Ë™ç„Éú„Çø„É≥
                document.getElementById('openSheetsBtn').addEventListener('click', function() {
                    if (gasUrl) {
                        // URL„Åã„Çâ„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàID„ÇíÊäΩÂá∫„Åó„Å¶Google Sheets„ÇíÈñã„Åè
                        const match = gasUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                        if (match) {
                            window.open(`https://docs.google.com/spreadsheets/d/${match[1]}`, '_blank');
                        } else {
                            alert('Google Sheets„ÅÆURL„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇGoogle Apps Script„ÅÆ„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàID„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        }
                    } else {
                        alert('Google Apps Script URL„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                    }
                });

                // CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éú„Çø„É≥
                document.getElementById('exportBtn').addEventListener('click', exportToCSV);

                // „Ç¢„Ç§„ÉÜ„É†„É™„Çπ„Éà„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÔºàÊ±∫ÂÆöÊ∏à„ÅøÂàá„ÇäÊõø„ÅàÔºâ
                document.addEventListener('click', async function(e) {
                    if (e.target.classList.contains('btn-toggle-completed')) {
                        const itemCard = e.target.closest('.item-card');
                        const itemId = itemCard.dataset.id;
                        const item = items.find(item => item.id === itemId);
                        
                        if (item && gasUrl) {
                            const newCompletedStatus = !item.completed;
                            const success = await updateItemInAPI(itemId, { 
                                completed: newCompletedStatus 
                            });
                            
                            if (success) {
                                item.completed = newCompletedStatus;
                                displayItems();
                                updateSummary();
                            }
                        }
                    }
                });
            });

        })();
    </script>
</body>
</html>
