<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¢ãƒ«ãƒ¢ãƒ‹ãƒ¼ç„ æ©Ÿæãƒ»å‚™å“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        /* CSSã¯å¤‰æ›´ãªã— */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .database-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .database-status.connected {
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid #28a745;
            color: #155724;
        }

        .database-status.disconnected {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid #dc3545;
            color: #721c24;
        }

        .database-status.connecting {
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid #ffc107;
            color: #856404;
        }
        
        .main-content {
            padding: 20px;
        }
        
        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #20c997);
            color: white;
        }
        
        .btn:hover, .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .category-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin: 10px 0;
        }
        
        .category-btn {
            padding: 12px 8px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
            touch-action: manipulation;
            font-size: 14px;
        }
        
        .category-btn:hover, .category-btn:active {
            background: #f8f9fa;
        }
        
        .category-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }
        
        .item-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            position: relative;
        }
        
        .item-card.completed {
            border-color: #28a745;
            background: #f8fff9;
        }

        .item-card.syncing {
            border-color: #ffc107;
            background: #fff8e1;
        }

        .item-card.syncing::after {
            content: "ğŸ”„ åŒæœŸä¸­...";
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffc107;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .item-card:hover, .item-card:active {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .item-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            flex-direction: column;
        }
        
        @media (min-width: 500px) {
            .item-header {
                flex-direction: row;
                align-items: center;
            }
        }
        
        .item-photo {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #ddd;
            margin-bottom: 10px;
        }
        
        @media (min-width: 500px) {
            .item-photo {
                width: 100px;
                height: 100px;
                margin-right: 15px;
                margin-bottom: 0;
            }
        }
        
        .item-details {
            flex: 1;
        }
        
        .item-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .summary-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .summary-card {
            background: rgba(255,255,255,0.1);
            padding: 15px 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-card h4 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        
        .summary-card p {
            font-size: 0.9em;
        }
        
        .user-info {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .hidden {
            display: none !important;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
            flex-direction: column;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .setup-section {
            background: #e8f4f8;
            border: 2px solid #17a2b8;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .setup-steps {
            list-style: none;
            counter-reset: step-counter;
        }

        .setup-steps li {
            counter-increment: step-counter;
            margin-bottom: 15px;
            padding-left: 30px;
            position: relative;
        }

        .setup-steps li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            background: #17a2b8;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .section {
                padding: 15px;
            }
            
            .category-buttons {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 6px;
            }
            
            .category-btn {
                padding: 10px 6px;
                font-size: 13px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ½ï¸ ã‚¢ãƒ«ãƒ¢ãƒ‹ãƒ¼ç„</h1>
            <p>æ©Ÿæãƒ»å‚™å“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆVercelç‰ˆï¼‰</p>
        </div>
        
        <div class="main-content">
            <div id="databaseStatus" class="database-status connecting">
                ğŸŸ¡ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
            </div>
            
            <div class="section">
                <h3>ğŸ‘¤ å…¥åŠ›è€…è¨­å®š</h3>
                <div class="form-group">
                    <label>å…¥åŠ›è€…åã‚’é¸æŠã—ã¦ãã ã•ã„</label>
                    <select id="userSelect">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="ä¸‰ãƒ¶å°»">ä¸‰ãƒ¶å°»</option>
                        <option value="æ¡‚">æ¡‚</option>
                        <option value="é˜¿æ¯”ç•™">é˜¿æ¯”ç•™</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="setUserBtn">è¨­å®š</button>
                <div id="currentUser" class="user-info hidden"></div>
            </div>
            
            <div class="section">
                <h3>ğŸ“ æ–°ã—ã„å“ç›®ã‚’è¿½åŠ </h3>
                
                <div class="form-group">
                    <label>ğŸ“· å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ <span style="color: #6c757d; font-size: 14px;">(ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</span></label>
                    <input type="file" id="photoInput" accept="image/*" capture="environment">
                    <div id="photoPreview" class="hidden" style="margin-top: 10px;">
                        <img id="previewImage" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid #ddd;">
                        <p id="compressionInfo" style="font-size: 12px; color: #6c757d; margin-top: 5px;"></p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ğŸ“‹ å“å</label>
                    <input type="text" id="itemName" placeholder="å“ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                </div>
                
                <div class="form-group">
                    <label>ğŸ”¢ å€‹æ•°</label>
                    <input type="number" id="itemCount" value="1" min="1">
                </div>

                <div class="form-group">
                    <label>ğŸ“ ãƒ¡ãƒ¢ãƒ»å‚™è€ƒ</label>
                    <input type="text" id="itemMemo" placeholder="ã‚µã‚¤ã‚ºã€çŠ¶æ…‹ã€ç‰¹è¨˜äº‹é …ãªã©ï¼ˆä»»æ„ï¼‰">
                </div>
                
                <div class="form-group">
                    <label>ğŸ·ï¸ å±æ€§ã‚’é¸æŠ</label>
                    <div class="category-buttons" id="categoryButtons">
                        <button class="category-btn" data-value="å¨æˆ¿å™¨å…·">å¨æˆ¿å™¨å…·</button>
                        <button class="category-btn" data-value="åº—å†…æ©Ÿæ">åº—å†…æ©Ÿæ</button>
                        <button class="category-btn" data-value="é£Ÿå™¨é¡">é£Ÿå™¨é¡</button>
                        <button class="category-btn" data-value="å‚™å“">å‚™å“</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>âš¡ å–æ‰±ã„æ–¹æ³•</label>
                    <div class="category-buttons" id="handlingButtons">
                        <button class="category-btn" data-value="å‡¦åˆ†">å‡¦åˆ†</button>
                        <button class="category-btn" data-value="è­²æ¸¡">è­²æ¸¡</button>
                        <button class="category-btn" data-value="é€ã‚Š">é€ã‚Š</button>
                    </div>
                    <div id="destinationDiv" class="form-group hidden">
                        <label>è­²æ¸¡å…ˆ/é€ã‚Šå…ˆ</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px;" id="destinationButtons">
                            <button type="button" class="category-btn" data-value="å¯¾é¦¬">å¯¾é¦¬</button>
                            <button type="button" class="category-btn" data-value="è¥¿æ–°">è¥¿æ–°</button>
                            <button type="button" class="category-btn" data-value="ç¤¾é•·è‡ªå®…">ç¤¾é•·è‡ªå®…</button>
                            <button type="button" class="category-btn" data-value="ãã®ä»–">ãã®ä»–</button>
                        </div>
                        <input type="text" id="destination" placeholder="ãã®ä»–ã®å ´åˆã¯ç›´æ¥å…¥åŠ›" style="display: none;">
                    </div>
                </div>
                
                <button class="btn btn-success" id="addItemBtn">å“ç›®ã‚’è¿½åŠ </button>
                <p id="addItemStatus" style="font-size: 14px; color: #666; margin-top: 5px;">
                    âœ… æ¥ç¶šæ¸ˆã¿
                </p>
            </div>
            
            <div class="section">
                <h3>ğŸ“¦ ç™»éŒ²æ¸ˆã¿å“ç›®ä¸€è¦§</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="btn btn-info" id="refreshBtn">ğŸ”„ æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</button>
                    <button class="btn btn-primary" id="openAirtableBtn">ğŸ“Š Airtableã§ç¢ºèª</button>
                </div>
                <div id="itemsList">
                    <p style="text-align: center; color: #6c757d; padding: 40px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>
            
            <div class="summary-section">
                <h3>ğŸ“Š é›†è¨ˆæƒ…å ±</h3>
                <div class="summary-grid" id="summaryGrid">
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>ç·å“ç›®æ•°</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>æ±ºå®šæ¸ˆã¿</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>å¨æˆ¿å™¨å…·</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>åº—å†…æ©Ÿæ</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>é£Ÿå™¨é¡</p>
                    </div>
                    <div class="summary-card">
                        <h4>-</h4>
                        <p>å‚™å“</p>
                    </div>
                </div>
                <button class="btn btn-success" id="exportBtn">ğŸ“„ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            </div>
        </div>
    </div>
    
    <script>
        (function() {
            'use strict';
            
            let currentUser = '';
            let items = [];
            let selectedCategory = '';
            let selectedHandling = '';
            
            // æ¥ç¶šçŠ¶æ…‹ã®æ›´æ–°
            function updateConnectionStatus(status) {
                const statusDiv = document.getElementById('databaseStatus');
                statusDiv.className = 'database-status ' + status;
                
                switch(status) {
                    case 'connected':
                        statusDiv.innerHTML = 'ğŸŸ¢ Airtableæ¥ç¶šæ¸ˆã¿ - ãƒ‡ãƒ¼ã‚¿åŒæœŸå¯èƒ½';
                        break;
                    case 'connecting':
                        statusDiv.innerHTML = 'ğŸŸ¡ ãƒ‡ãƒ¼ã‚¿åŒæœŸä¸­...';
                        break;
                    case 'disconnected':
                        statusDiv.innerHTML = 'ğŸ”´ æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                        break;
                }
            }
            
            // Airtableã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            async function loadItemsFromAPI() {
                updateConnectionStatus('connecting');
                try {
                    const response = await fetch('/api/items');
                    if (!response.ok) {
                        throw new Error(`APIã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }
                    const data = await response.json();
                    items = data.records.map(record => ({
                        id: record.id,
                        name: record.fields['å“å'] || '',
                        count: record.fields['å€‹æ•°'] || 1,
                        category: record.fields['å±æ€§'] || 'å‚™å“',
                        handling: record.fields['å–æ‰±ã„æ–¹æ³•'] || 'æœªæ±ºå®š',
                        destination: record.fields['é€ã‚Šå…ˆ'] || '',
                        completed: record.fields['æ±ºå®šæ¸ˆã¿'] || false,
                        addedBy: record.fields['ç™»éŒ²è€…'] || '',
                        addedAt: record.fields['ç™»éŒ²æ—¥æ™‚'] || '',
                        memo: record.fields['ãƒ¡ãƒ¢'] || '',
                        photoUrl: record.fields['å†™çœŸ'] ? record.fields['å†™çœŸ'][0]?.url : null
                    }));

                    displayItems();
                    updateSummary();
                    updateConnectionStatus('connected');
                    console.log('APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', items.length, 'ä»¶');
                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    updateConnectionStatus('disconnected');
                    alert('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                }
            }
            
            // Airtableã«å“ç›®è¿½åŠ 
            async function addItemToAPI(item) {
                showLoading('å“ç›®ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™...');
                try {
                    const response = await fetch('/api/items', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(item)
                    });

                    if (!response.ok) {
                        throw new Error(`è¿½åŠ ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }
                    
                    const newItem = await response.json();
                    await loadItemsFromAPI();
                    hideLoading();
                    alert('âœ… å“ç›®ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼');
                    
                } catch (error) {
                    console.error('APIè¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                    hideLoading();
                    alert('âŒ å“ç›®è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            }
            
            // Airtableã®å“ç›®æ›´æ–°
            async function updateItemInAPI(recordId, updates) {
                showLoading('å“ç›®ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™...');
                try {
                    const response = await fetch(`/api/items?id=${recordId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updates)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }

                    await loadItemsFromAPI();
                    hideLoading();
                    return true;
                } catch (error) {
                    console.error('APIæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    hideLoading();
                    alert('âŒ å“ç›®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                    return false;
                }
            }

            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            function showError(message) {
                console.error(message);
                hideLoading();
                alert('ã‚¨ãƒ©ãƒ¼: ' + message);
            }

            function showLoading(message) {
                const existingOverlay = document.querySelector('.loading-overlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }

                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.innerHTML = '<div class="loading-spinner"></div><div>' + message + '</div>';
                document.body.appendChild(overlay);
                return overlay;
            }

            function hideLoading() {
                const overlay = document.querySelector('.loading-overlay');
                if (overlay) {
                    overlay.remove();
                }
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
            function setUser() {
                try {
                    const userSelect = document.getElementById('userSelect');
                    const username = userSelect.value;
                    
                    if (!username) {
                        alert('å…¥åŠ›è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    
                    currentUser = username;
                    
                    const userDiv = document.getElementById('currentUser');
                    userDiv.innerHTML = 'ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: <strong>' + username + '</strong> ã•ã‚“';
                    userDiv.classList.remove('hidden');
                    
                    alert('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œ' + username + 'ã€ã«è¨­å®šã•ã‚Œã¾ã—ãŸã€‚');
                } catch (error) {
                    showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            }
            
            // è»½é‡ç”»åƒå‡¦ç†ï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
            function processImageForMobile(file) {
                return new Promise((resolve, reject) => {
                    try {
                        const maxFileSize = 5 * 1024 * 1024; // 5MB
                        const maxResolution = 1024; // 1024px
                        const reader = new FileReader();

                        if (file.size > maxFileSize) {
                            reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰'));
                            return;
                        }

                        if (!file.type.startsWith('image/')) {
                            reject(new Error('æœ‰åŠ¹ãªç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'));
                            return;
                        }

                        reader.onload = function(event) {
                            const img = new Image();
                            img.onload = function() {
                                let width = img.width;
                                let height = img.height;
                                let ratio = width / height;

                                if (width > maxResolution || height > maxResolution) {
                                    if (width > height) {
                                        width = maxResolution;
                                        height = width / ratio;
                                    } else {
                                        height = maxResolution;
                                        width = height * ratio;
                                    }
                                }

                                const canvas = document.createElement('canvas');
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);

                                const resizedDataURL = canvas.toDataURL('image/jpeg', 0.8); // 80%å“è³ª
                                resolve(resizedDataURL);
                            };
                            img.src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    } catch (e) {
                        reject(e);
                    }
                });
            }

            // å“ç›®ä¸€è¦§ã®è¡¨ç¤º
            function displayItems() {
                const itemsList = document.getElementById('itemsList');
                itemsList.innerHTML = '';
                
                if (items.length === 0) {
                    itemsList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                items.forEach(item => {
                    const itemCard = document.createElement('div');
                    itemCard.className = `item-card ${item.completed ? 'completed' : ''}`;
                    itemCard.dataset.id = item.id;
                    
                    const itemHeader = document.createElement('div');
                    itemHeader.className = 'item-header';

                    if (item.photoUrl) {
                        const photo = document.createElement('img');
                        photo.src = item.photoUrl;
                        photo.className = 'item-photo';
                        itemHeader.appendChild(photo);
                    }
                    
                    const itemDetails = document.createElement('div');
                    itemDetails.className = 'item-details';
                    itemDetails.innerHTML = `
                        <h3>${item.name} (${item.count}å€‹)</h3>
                        <p style="font-size: 14px; color: #666;">
                            ğŸ·ï¸ ${item.category} | âš¡ ${item.handling}${item.destination ? ' (' + item.destination + ')' : ''}
                        </p>
                        <p style="font-size: 12px; color: #888; margin-top: 5px;">
                            ç™»éŒ²è€…: ${item.addedBy}
                        </p>
                    `;
                    itemHeader.appendChild(itemDetails);

                    itemCard.appendChild(itemHeader);
                    
                    if (item.memo) {
                        const memo = document.createElement('p');
                        memo.style.cssText = 'font-size: 14px; margin-top: 10px; padding: 5px; background: #e9ecef; border-radius: 6px;';
                        memo.textContent = `å‚™è€ƒ: ${item.memo}`;
                        itemCard.appendChild(memo);
                    }

                    const controls = document.createElement('div');
                    controls.className = 'item-controls';
                    controls.innerHTML = `
                        <button class="btn btn-info btn-toggle-completed">
                            ${item.completed ? 'âœ… æ±ºå®šæ¸ˆã¿' : 'â˜‘ï¸ æ±ºå®šæ¸ˆã¿ã«ã™ã‚‹'}
                        </button>
                    `;
                    itemCard.appendChild(controls);
                    
                    itemsList.appendChild(itemCard);
                });
            }

            // é›†è¨ˆæƒ…å ±ã®æ›´æ–°
            function updateSummary() {
                const totalCount = items.length;
                const completedCount = items.filter(item => item.completed).length;
                
                const categoryCounts = items.reduce((acc, item) => {
                    acc[item.category] = (acc[item.category] || 0) + 1;
                    return acc;
                }, {});

                const summaryCards = document.getElementById('summaryGrid').children;
                summaryCards[0].querySelector('h4').textContent = totalCount;
                summaryCards[1].querySelector('h4').textContent = completedCount;
                summaryCards[2].querySelector('h4').textContent = categoryCounts['å¨æˆ¿å™¨å…·'] || 0;
                summaryCards[3].querySelector('h4').textContent = categoryCounts['åº—å†…æ©Ÿæ'] || 0;
                summaryCards[4].querySelector('h4').textContent = categoryCounts['é£Ÿå™¨é¡'] || 0;
                summaryCards[5].querySelector('h4').textContent = categoryCounts['å‚™å“'] || 0;
            }

            // ã‚«ãƒ†ã‚´ãƒªãƒ»å–æ‰±ã„ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            function resetCategoryButtons() {
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                selectedCategory = '';
                selectedHandling = '';
                document.getElementById('destinationDiv').classList.add('hidden');
                document.getElementById('destination').value = '';
                document.getElementById('photoInput').value = '';
                document.getElementById('photoPreview').classList.add('hidden');
            }

            // å“ç›®è¿½åŠ ãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©
            document.getElementById('addItemBtn').addEventListener('click', async () => {
                if (!currentUser) {
                    alert('ã¾ãšã€å…¥åŠ›è€…åã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                const itemName = document.getElementById('itemName').value.trim();
                const itemCount = parseInt(document.getElementById('itemCount').value);
                const itemMemo = document.getElementById('itemMemo').value.trim();

                if (!itemName) {
                    alert('å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                const destinationInput = document.getElementById('destination');
                const finalDestination = selectedHandling === 'ãã®ä»–' ? destinationInput.value : document.querySelector('.category-btn.active[data-target="destination"]')?.dataset.value || '';
                
                let photoDataUrl = null;
                const photoInput = document.getElementById('photoInput');
                if (photoInput.files.length > 0) {
                    try {
                        photoDataUrl = await processImageForMobile(photoInput.files[0]);
                    } catch (error) {
                        alert(error.message);
                        return;
                    }
                }

                const newItem = {
                    name: itemName,
                    count: itemCount,
                    category: selectedCategory,
                    handling: selectedHandling,
                    destination: finalDestination,
                    addedBy: currentUser,
                    addedAt: new Date().toISOString(),
                    memo: itemMemo,
                    photoDataUrl: photoDataUrl
                };
                
                await addItemToAPI(newItem);
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('itemName').value = '';
                document.getElementById('itemCount').value = '1';
                document.getElementById('itemMemo').value = '';
                resetCategoryButtons();
            });

            // æ±ºå®šæ¸ˆã¿ãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©
            document.getElementById('itemsList').addEventListener('click', async (e) => {
                if (e.target.classList.contains('btn-toggle-completed')) {
                    const itemCard = e.target.closest('.item-card');
                    const recordId = itemCard.dataset.id;
                    const item = items.find(i => i.id === recordId);

                    if (item) {
                        const updates = { 'æ±ºå®šæ¸ˆã¿': !item.completed };
                        await updateItemInAPI(recordId, updates);
                    }
                }
            });

            // Refreshãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©
            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadItemsFromAPI();
            });

            // Airtableã§ç¢ºèªãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©
            document.getElementById('openAirtableBtn').addEventListener('click', () => {
                showError('ã“ã®æ©Ÿèƒ½ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰Base IDã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
            });
            
            // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©
            document.getElementById('exportBtn').addEventListener('click', () => {
                if (items.length === 0) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }
                
                const headers = ['å“å', 'å€‹æ•°', 'å±æ€§', 'å–æ‰±ã„æ–¹æ³•', 'é€ã‚Šå…ˆ', 'æ±ºå®šæ¸ˆã¿', 'ç™»éŒ²è€…', 'ç™»éŒ²æ—¥æ™‚', 'ãƒ¡ãƒ¢'];
                const rows = items.map(item => [
                    item.name,
                    item.count,
                    item.category,
                    item.handling,
                    item.destination,
                    item.completed ? 'ã¯ã„' : 'ã„ã„ãˆ',
                    item.addedBy,
                    item.addedAt,
                    item.memo
                ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(','));
                
                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows].join('\n');
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "å‚™å“ãƒªã‚¹ãƒˆ.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©
            document.getElementById('categoryButtons').addEventListener('click', (e) => {
                if (e.target.classList.contains('category-btn')) {
                    const allButtons = e.target.parentNode.querySelectorAll('.category-btn');
                    allButtons.forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    selectedCategory = e.target.dataset.value;
                }
            });
            
            // å–æ‰±ã„æ–¹æ³•ãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©
            document.getElementById('handlingButtons').addEventListener('click', (e) => {
                if (e.target.classList.contains('category-btn')) {
                    const allButtons = e.target.parentNode.querySelectorAll('.category-btn');
                    allButtons.forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    selectedHandling = e.target.dataset.value;
                    const destinationDiv = document.getElementById('destinationDiv');
                    if (selectedHandling === 'è­²æ¸¡' || selectedHandling === 'é€ã‚Š') {
                        destinationDiv.classList.remove('hidden');
                    } else {
                        destinationDiv.classList.add('hidden');
                        document.getElementById('destination').style.display = 'none';
                    }
                }
            });
            
            // é€ã‚Šå…ˆãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©
            document.getElementById('destinationButtons').addEventListener('click', (e) => {
                if (e.target.classList.contains('category-btn')) {
                    const allButtons = e.target.parentNode.querySelectorAll('.category-btn');
                    allButtons.forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    if (e.target.dataset.value === 'ãã®ä»–') {
                        document.getElementById('destination').style.display = 'block';
                    } else {
                        document.getElementById('destination').style.display = 'none';
                    }
                }
            });

            // å†™çœŸå…¥åŠ›ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            document.getElementById('photoInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                const previewDiv = document.getElementById('photoPreview');
                const previewImg = document.getElementById('previewImage');
                const compressionInfo = document.getElementById('compressionInfo');

                if (file) {
                    processImageForMobile(file)
                        .then(dataUrl => {
                            previewImg.src = dataUrl;
                            previewDiv.classList.remove('hidden');
                            compressionInfo.textContent = `å†™çœŸã‚µã‚¤ã‚ºã‚’ ${Math.round(dataUrl.length / 1024)} KB ã«åœ§ç¸®ã—ã¾ã—ãŸã€‚`;
                        })
                        .catch(error => {
                            alert(error.message);
                            e.target.value = null;
                            previewDiv.classList.add('hidden');
                        });
                } else {
                    previewDiv.classList.add('hidden');
                }
            });

            // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
            document.getElementById('setUserBtn').addEventListener('click', setUser);
            
            // åˆå›ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadItemsFromAPI();
        })();
    </script>
</body>
</html>
